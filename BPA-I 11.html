<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema BPA-I - Boletim de Produção Ambulatorial com Dados Individualizados">
    <title>Sistema BPA-I - Boletim de Produção Ambulatorial</title>
    <style>
        /* Reset de estilos básicos para garantir consistência entre navegadores */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Estilos do corpo da página: fonte, fundo gradiente, altura mínima para preencher a tela */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Contêiner principal para centralizar o conteúdo e limitar a largura */
        .container {
            max-width: 1200px;
            margin: 0 auto; /* Centraliza horizontalmente */
            padding: 20px;
        }

        /* Estilos do cabeçalho da aplicação: fundo semi-transparente com desfoque, sombra e texto centralizado */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        /* Estilos dos cartões (seções da aplicação): fundo, bordas arredondadas, sombra e transição ao passar o mouse */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px); /* Efeito de elevação */
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        /* Estilos para input de arquivo (oculto e estilizado por um label) */
        .file-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            left: -9999px; /* Move para fora da tela */
            opacity: 0; /* Torna invisível */
        }

        .file-input-label {
            display: block;
            padding: 15px 30px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1em;
        }

        .file-input-label:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: scale(1.05);
        }

        /* Estilos gerais dos botões: padding, bordas arredondadas, transição */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex; /* Para alinhar ícones e texto */
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: scale(1.05);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(45deg, #e67e22, #f39c12);
            transform: scale(1.05);
        }

        /* Estilos para grupos de formulário (label + input/select/textarea) */
        .form-group {
            margin-bottom: 20px;
            position: relative; /* Necessário para posicionar o dropdown de pesquisa */
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Layout de grade responsivo para formulários e estatísticas */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Contêiner para tabelas com scroll vertical */
        .table-container {
            max-height: 500px;
            overflow: auto;
            border-radius: 8px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Estilos da tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky; /* Fixa o cabeçalho ao rolar */
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Indicadores de status (válido, aviso, erro) */
        .status-indicator {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Estilo para campos com erro de validação */
        .field-error {
            background-color: #ffe6e6 !important;
            border-left: 3px solid #e74c3c !important;
            font-weight: bold;
        }
        
        /* Detalhes do erro (ícone de aviso) */
        .error-details {
            display: inline-block;
            margin-left: 5px;
            cursor: help;
            font-size: 1.2em;
        }
        
        /* Botões de ação na tabela (editar, excluir) */
        .btn-action {
            padding: 5px 8px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* Layout de grade para cartões de estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Estilos dos cartões de estatísticas */
        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Classe para ocultar elementos */
        .hidden {
            display: none;
        }

        /* Estilo para mensagens de carregamento */
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        /* Barra de progresso (oculta por padrão) - Atualmente não utilizada, mas mantida para futuras implementações */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Estilos do Modal (pop-up): fixo na tela, centralizado, fundo semi-transparente */
        .modal {
            display: none; /* Oculto por padrão via CSS */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh; /* Altura máxima para permitir scroll */
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative; /* Para o botão fechar */
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }

        /* Estilos específicos para modais de confirmação (menores e centralizados) */
        #deleteConfirmModal .modal-content,
        #clearDataConfirmModal .modal-content,
        #importConfirmModal .modal-content,
        #jsonImportConfirmModal .modal-content, /* Adicionado para o novo modal JSON */
        #cityDeleteConfirmModal .modal-content {
            max-width: 500px;
            text-align: center;
        }

        #deleteConfirmModal .modal-content h3,
        #clearDataConfirmModal .modal-content h3,
        #importConfirmModal .modal-content h3,
        #jsonImportConfirmModal .modal-content h3, /* Adicionado para o novo modal JSON */
        #cityDeleteConfirmModal .modal-content h3 {
            color: #e74c3c; /* Vermelho para alerta */
            margin-bottom: 20px;
        }

        #deleteConfirmModal .modal-content input[type="text"],
        #clearDataConfirmModal .modal-content input[type="text"],
        #importConfirmModal .modal-content input[type="text"],
        #jsonImportConfirmModal .modal-content input[type="text"], /* Adicionado para o novo modal JSON */
        #cityDeleteConfirmModal .modal-content input[type="text"] {
            border: 2px solid #e74c3c;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #deleteConfirmModal .modal-content .btn,
        #clearDataConfirmModal .modal-content .btn,
        #importConfirmModal .modal-content .btn,
        #jsonImportConfirmModal .modal-content .btn, /* Adicionado para o novo modal JSON */
        #cityDeleteConfirmModal .modal-content .btn {
            margin: 10px;
        }

        /* Botões de transporte: estilização com borda e transição */
        .transport-btn {
            padding: 15px 20px;
            border: 2px solid #e67e22;
            border-radius: 8px;
            background: white;
            color: #e67e22;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .transport-btn:hover {
            background: #f39c12;
            color: white;
            transform: scale(1.02);
        }
        
        .transport-btn.selected {
            background: #e67e22;
            color: white;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3);
        }
        
        /* Estilos para impressão */
        @media print {
            @page {
                size: A4 landscape; /* Tamanho da página e orientação */
                margin: 0.5cm; /* Margens menores para impressão */
            }
            
            * {
                box-sizing: border-box;
            }
            
            html, body {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                background: white !important; /* Força fundo branco */
                color: black !important; /* Força texto preto */
            }
            
            body * {
                visibility: hidden; /* Oculta tudo por padrão */
                background: transparent !important;
            }
            
            #reportContent {
                visibility: visible !important; /* Torna o conteúdo do relatório visível */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background: white !important;
                color: black !important;
            }
            
            #reportContent * {
                visibility: visible !important; /* Torna todos os elementos dentro do relatório visíveis */
                background: transparent !important;
                color: black !important;
            }
            
            .report-header {
                text-align: center;
                margin-bottom: 15px;
                background: white !important;
            }
            
            .report-header h1 {
                font-size: 18px;
                margin: 5px 0;
                color: black !important;
            }
            
            .report-header h2 {
                font-size: 16px;
                margin: 3px 0;
                color: black !important;
            }
            
            .report-header p {
                font-size: 12px;
                margin: 2px 0;
                color: black !important;
            }
            
            .report-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 8px; /* Fonte menor para caber mais dados */
                background: white !important;
                color: black !important;
                word-wrap: break-word; /* Quebra de linha para palavras longas */
                white-space: normal;
                vertical-align: top;
            }
            
            .report-table th, .report-table td {
                border: 1px solid black;
                padding: 2px;
                text-align: left;
                font-size: 8px;
                background: white !important;
                color: black !important;
                word-wrap: break-word; /* Quebra de linha para palavras longas */
                white-space: normal;
                vertical-align: top;
            }
            
            .report-table th {
                font-weight: bold;
                background: #f5f5f5 !important;
            }

            /* Forçar cores de fundo dos grupos na impressão */
            .group-odd {
                background-color: #f8f8f8 !important; /* Cinza muito claro */
            }
            .group-even {
                background-color: #f0f0f0 !important; /* Cinza claro ligeiramente mais escuro */
            }
        }
        
        /* Estilos da tabela de relatório (visualização na tela) */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        
        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
            word-wrap: break-word;
            white-space: normal;
            vertical-align: top;
        }
        
        .report-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            font-size: 9px;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* Otimizações para Windows Desktop (ajustes de responsividade) */
        @media (max-width: 1400px) {
            .container {
                max-width: 95%;
            }
        }
        
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Estilos para o dropdown de pesquisa de pacientes */
        .search-results-dropdown {
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            position: absolute; /* Posiciona o dropdown abaixo do input */
            z-index: 100;
            background-color: white;
            width: calc(100% - 4px); /* Ajusta para a borda */
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none; /* Oculto por padrão */
        }

        .search-results-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .search-results-item:hover {
            background-color: #f0f0f0;
        }

        .search-results-item:last-child {
            border-bottom: none;
        }

        /* Estilos para os grupos de relatório (cores alternadas) */
        .group-odd {
            background-color: #f8f8f8; /* Cinza muito claro */
        }
        .group-even {
            background-color: #f0f0f0; /* Cinza claro ligeiramente mais escuro */
        }
        /* Recuo para linhas de acompanhantes no relatório */
        .companion-row td {
            padding-left: 20px !important; /* Recua acompanhantes */
            font-style: italic;
            color: #555;
        }
        /* Garante que os estilos de impressão sobreponham, se necessário */
        @media print {
            .companion-row td {
                padding-left: 10px !important; /* Recuo ligeiramente menor para impressão */
                font-style: italic;
                color: #333;
            }
        }

        /* Estilos para a mensagem Toast */
        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            font-size: 1em;
            min-width: 250px;
            max-width: 350px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .toast.success {
            background-color: #28a745; /* Verde */
        }

        .toast.error {
            background-color: #dc3545; /* Vermelho */
        }

        .toast.warning {
            background-color: #ffc107; /* Amarelo */
            color: #333;
        }

        .toast.info {
            background-color: #17a2b8; /* Azul claro */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Sistema BPA-I</h1>
            <p>Boletim de Produção Ambulatorial - Dados Individualizados</p>
        </div>

        <!-- Seção de Visualização da Exportação (oculta por padrão) -->
        <div class="card hidden" id="exportPreview">
            <h2>👁️ Visualização da Exportação</h2>
            <div style="margin-bottom: 15px;">
                <span><strong>Formato:</strong> CSV com colunas separadas por ponto e vírgula (;)</span>
                <span><strong>Encoding:</strong> UTF-8 com BOM para compatibilidade com Excel</span>
            </div>
            <div class="table-container">
                <table id="previewTable">
                    <thead id="previewHeader"></thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closePreview()">❌ Fechar Visualização</button>
            </div>
        </div>

        <!-- Seção de Estatísticas (oculta por padrão) -->
        <div class="card hidden" id="statisticsCard">
            <h2>📊 Estatísticas</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">Total de Registros</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="validRecords">0</div>
                    <div class="stat-label">Registros Válidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorRecords">0</div>
                    <div class="stat-label">Registros com Erro</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalProcedures">0</div>
                    <div class="stat-label">Procedimentos</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="toggleStatistics()">❌ Fechar Estatísticas</button>
            </div>
        </div>

        <!-- Modal Principal de Configurações -->
        <div id="configModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>⚙️ Configurações Administrativas</h2>
                    <span class="close" onclick="closeConfigModal()">&times;</span>
                </div>
                
                <div style="text-align: center;">
                    <h3>Selecione uma opção:</h3>
                    <div style="margin: 30px 0;">
                        <button class="btn btn-primary" onclick="openCitiesModal()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            🏢 Gerenciar Cidades
                        </button>
                        <!-- BOTÃO ALTERADO PARA GERAR RELATÓRIO DE LOG -->
                        <button class="btn btn-secondary" onclick="generateValidationLogReport()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            📋 Gerar Relatório (Log)
                        </button>
                        <br>
                        <button class="btn btn-primary" onclick="previewExport()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            👁️ Visualizar Exportação
                        </button>
                        <button class="btn btn-secondary" onclick="exportExcel()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            📊 Exportar Dados
                        </button>
                        <br>
                        <input type="file" id="importDataFile" accept=".csv" style="display: none;">
                        <button class="btn btn-primary" onclick="selectFileToImport()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            📁 Importar Dados (CSV)
                        </button>
                        <input type="file" id="importJsonFile" accept=".json" style="display: none;">
                        <button class="btn btn-primary" onclick="selectJsonFileToImport()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            📦 Importar Backup (JSON)
                        </button>
                        <br><br>
                        <button class="btn btn-secondary" onclick="showClearDataConfirmModal()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em; background: #e74c3c; border-color: #c0392b;">
                            🗑️ Limpar Todos os Dados
                        </button>
                        <br>
                        <button class="btn btn-primary" onclick="addExampleRecords()" style="margin: 10px; padding: 20px 30px; font-size: 1.1em;">
                            ➕ Adicionar Exemplos
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Gerenciar Cidades -->
        <div id="citiesModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>🏢 Gerenciar Cidades</h2>
                    <span class="close" onclick="closeCitiesModal()">&times;</span>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3>Adicionar Nova Cidade</h3>
                    <div class="grid">
                        <div class="form-group">
                            <label for="originCityName">Cidade de Partida:</label>
                            <input type="text" id="originCityName" value="Pedra Bonita, MG" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="cityName">Cidade Destino:</label>
                            <input type="text" id="cityName" placeholder="Nome da cidade destino" maxlength="50">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cityKm">Distância (KM) - Ida e Volta:</label>
                        <input type="number" id="cityKm" placeholder="Calculado automaticamente ou digite" min="0">
                        <small style="color: #666; font-size: 0.9em;">Será o dobro da distância de ida.</small>
                    </div>
                    <div class="form-group">
                        <label for="cityProcedures">Total de Procedimentos:</label>
                        <input type="number" id="cityProcedures" placeholder="Calculado automaticamente" min="0">
                        <small style="color: #666; font-size: 0.9em;">Cálculo: 1 procedimento a cada 50km</small>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <button type="button" class="btn btn-secondary" onclick="calculateDistanceAndProcedures()">🌍 Calcular Distância</button>
                        <button type="button" id="saveCityBtn" class="btn btn-primary" onclick="saveOrUpdateCity()">➕ Adicionar Cidade</button>
                        <button type="button" class="btn btn-secondary" onclick="clearCityForm()">🔄 Limpar / Cancelar Edição</button>
                    </div>
                </div>
                    
                    <div style="margin-bottom: 30px; border-top: 2px solid #ecf0f1; padding-top: 20px;">
                        <h3>Importar/Exportar Cidades</h3>
                        <div style="text-align: center; margin: 15px 0;">
                            <input type="file" id="importCitiesFile" accept=".csv" style="display: none;" onchange="importCities()">
                            <button class="btn btn-secondary" onclick="document.getElementById('importCitiesFile').click()">📁 Importar Cidades</button>
                            <button class="btn btn-primary" onclick="exportCities()">📊 Exportar Cidades</button>
                        </div>
                        <small style="color: #666; display: block; text-align: center;">Formato: CSV com colunas Nome;KM;Procedimentos</small>
                    </div>
                    
                    <div>
                        <h3>📋 Lista de Cidades Cadastradas</h3>
                        <div class="table-container" style="max-height: 400px; min-height: 200px;">
                            <table id="citiesTable">
                                <thead>
                                    <tr>
                                        <th>Cidade</th>
                                        <th>Distância (KM)</th>
                                        <th>Procedimentos</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="citiesTableBody">
                                    <tr>
                                        <td colspan="4" class="loading">Nenhuma cidade cadastrada</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal de Relatórios -->
            <div id="reportModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>📋 Relatórios do Sistema</h2>
                        <span class="close" onclick="closeReportModal()">&times;</span>
                    </div>
                    
                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                        <h3>Filtro por Data de Atendimento:</h3>
                        <div class="grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="reportStartDate">Data Inicial:</label>
                                <input type="date" id="reportStartDate">
                            </div>
                            <div class="form-group">
                                <label for="reportEndDate">Data Final:</label>
                                <input type="date" id="reportEndDate">
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <h3>Selecione o tipo de relatório:</h3>
                        <div style="margin: 30px 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <button class="btn btn-primary" onclick="generateTransportReport('cisverde')" style="padding: 20px; font-size: 1.1em;">
                                🚌 CisVerde
                            </button>
                            <button class="btn btn-primary" onclick="generateTransportReport('carros_saude')" style="padding: 20px; font-size: 1.1em;">
                                🚑 Carros da Saúde
                            </button>
                            <button class="btn btn-secondary" onclick="generateBPAReport()" style="padding: 20px; font-size: 1.1em;">
                                📄 BPA-I Completo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal de Visualização do Relatório -->
            <div id="reportViewModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 95%; width: 95%;">
                    <div class="modal-header">
                        <h2 id="reportTitle">📋 Relatório</h2>
                        <div>
                            <button class="btn btn-primary" onclick="printReport()" style="margin-right: 10px;">🖨️ Imprimir</button>
                            <span class="close" onclick="closeReportViewModal()">&times;</span>
                        </div>
                    </div>
                    
                    <div id="reportContent" style="background: white; padding: 20px; min-height: 400px; overflow: auto;">
                        <!-- Conteúdo do relatório será inserido aqui -->
                    </div>
                </div>
            </div>

            <!-- Modal de Confirmação de Exclusão de Registro -->
            <div id="deleteConfirmModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="color: #e74c3c;">⚠️ Confirmar Exclusão</h2>
                        <span class="close" onclick="closeDeleteConfirmModal()">&times;</span>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 1.1em;">Você está prestes a excluir o registro de: <strong id="recordToDeleteName"></strong>.</p>
                    <p style="margin-bottom: 20px;">Esta ação é irreversível. Para confirmar, digite <strong style="color: #e74c3c;">EXCLUIR</strong> no campo abaixo:</p>
                    <input type="text" id="deleteConfirmInput" placeholder="Digite EXCLUIR" style="width: 80%; padding: 10px; font-size: 1.2em; text-transform: uppercase;">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeDeleteConfirmModal()">Cancelar</button>
                        <button class="btn btn-delete" id="confirmDeleteBtn" disabled>Excluir Permanentemente</button>
                    </div>
                </div>
            </div>

            <!-- Modal de Confirmação de Exclusão de Cidade -->
            <div id="cityDeleteConfirmModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="color: #e74c3c;">⚠️ Confirmar Exclusão de Cidade</h2>
                        <span class="close" onclick="closeCityDeleteConfirmModal()">&times;</span>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 1.1em;">Você está prestes a excluir a cidade: <strong id="cityToDeleteName"></strong>.</p>
                    <p style="margin-bottom: 20px;">Esta ação é irreversível. Para confirmar, digite <strong style="color: #e74c3c;">REMOVER</strong> no campo abaixo:</p>
                    <input type="text" id="cityDeleteConfirmInput" placeholder="Digite REMOVER" style="width: 80%; padding: 10px; font-size: 1.2em; text-transform: uppercase;">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeCityDeleteConfirmModal()">Cancelar</button>
                        <button class="btn btn-delete" id="confirmCityDeleteBtn" disabled>Remover Cidade</button>
                    </div>
                </div>
            </div>

            <!-- Modal de Confirmação para Limpar Todos os Dados -->
            <div id="clearDataConfirmModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="color: #e74c3c;">🚨 Limpar TODOS os Dados?</h2>
                        <span class="close" onclick="closeClearDataConfirmModal()">&times;</span>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 1.1em;">Esta ação irá apagar **TODOS** os registros do sistema, incluindo pacientes, cidades e logs.</p>
                    <p style="margin-bottom: 20px;">**Esta ação é irreversível e não pode ser desfeita.**</p>
                    <p style="margin-bottom: 20px;">Para confirmar, digite <strong style="color: #e74c3c;">APAGAR TUDO</strong> no campo abaixo:</p>
                    <input type="text" id="clearDataConfirmInput" placeholder="Digite APAGAR TUDO" style="width: 80%; padding: 10px; font-size: 1.2em; text-transform: uppercase;">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeClearDataConfirmModal()">Cancelar</button>
                        <button class="btn btn-delete" id="confirmClearDataBtn" disabled>Limpar Dados Permanentemente</button>
                    </div>
                </div>
            </div>

            <!-- Modal de Confirmação para Importar Dados (Multi-step) -->
            <div id="importConfirmModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="importModalTitle">📁 Confirmar Importação</h2>
                        <span class="close" onclick="closeImportConfirmModal()">&times;</span>
                    </div>
                    <p id="importModalMessage" style="margin-bottom: 20px; font-size: 1.1em;"></p>
                    <input type="text" id="importConfirmInput" placeholder="Digite o texto de confirmação" style="width: 80%; padding: 10px; font-size: 1.2em; text-transform: uppercase; display: none;">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeImportConfirmModal()">Cancelar</button>
                        <button class="btn btn-primary" id="nextImportStepBtn">Continuar</button>
                    </div>
                </div>
            </div>

            <!-- NOVO: Modal de Confirmação para Importar Backup JSON (Multi-step) -->
            <div id="jsonImportConfirmModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="jsonImportModalTitle">📦 Confirmar Restauração de Backup JSON</h2>
                        <span class="close" onclick="closeJsonImportConfirmModal()">&times;</span>
                    </div>
                    <p id="jsonImportModalMessage" style="margin-bottom: 20px; font-size: 1.1em;"></p>
                    <input type="text" id="jsonImportConfirmInput" placeholder="Digite o texto de confirmação" style="width: 80%; padding: 10px; font-size: 1.2em; text-transform: uppercase; display: none;">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeJsonImportConfirmModal()">Cancelar</button>
                        <button class="btn btn-primary" id="nextJsonImportStepBtn">Continuar</button>
                    </div>
                </div>
            </div>

            <!-- Formulário de Cadastro Manual -->
            <div class="card">
                <form id="manualForm">
                    <!-- IDENTIFICAÇÃO DO PACIENTE -->
                    <fieldset style="border: 2px solid #3498db; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <legend style="color: #3498db; font-weight: bold; padding: 0 10px;">IDENTIFICAÇÃO DO PACIENTE</legend>
                        <!-- Primeira linha: CNS/CPF, Nome -->
                        <div class="grid">
                            <div class="form-group">
                                <label for="patientCNS">CNS/CPF:</label>
                                <input type="text" id="patientCNS" placeholder="CNS: 000 0000 0000 0000 ou CPF: 000.000.000-00" maxlength="18" autocomplete="off">
                                <small id="cnsTypeIndicator" style="color: #666; font-size: 0.9em;"></small>
                                <div id="cnsSearchResults" class="search-results-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label for="patientName">Nome:</label>
                                <input type="text" id="patientName" placeholder="Nome completo do paciente" maxlength="70" style="text-transform: uppercase;" autocomplete="off">
                                <div id="nameSearchResults" class="search-results-dropdown"></div>
                            </div>
                        </div>
                        <!-- Segunda linha: Sexo, Nascimento, Nacionalidade, Raça/Cor -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="gender">Sexo:</label>
                                <select id="gender">
                                    <option value="">Selecione</option>
                                    <option value="1">Masculino</option>
                                    <option value="2">Feminino</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="birthDate">Nascimento:</label>
                                <input type="date" id="birthDate">
                            </div>
                            <div class="form-group">
                                <label for="nacionalidade">Nacionalidade:</label>
                                <select id="nacionalidade">
                                    <option value="010">Brasileira</option>
                                    <option value="020">Naturalizado Brasileiro</option>
                                    <option value="030">Estrangeiro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="raca">Raça/Cor:</label>
                                <select id="raca">
                                    <option value="01">Branca</option>
                                    <option value="02">Preta</d>
                                    <option value="03" selected>Parda</option>
                                    <option value="04">Amarela</option>
                                    <option value="05">Indígena</option>
                                    <option value="99">Sem informação</option>
                                </select>
                            </div>
                        </div>
                        <!-- Terceira linha: Etnia, Logradouro, Bairro/Córrego (condicional) -->
                        <div id="logradouroRow" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group etnia-field" style="display: none;">
                                <label for="etnia">Etnia:</label>
                                <input type="text" id="etnia" placeholder="Código da etnia" maxlength="4">
                            </div>
                            <div class="form-group">
                                <label for="codLogradouro">Logradouro:</label>
                                <select id="codLogradouro">
                                    <option value="">Selecione</option>
                                    <option value="081">Área Urbana</option>
                                    <option value="024">Zona Rural</option>
                                </select>
                            </div>
                            <div class="form-group" id="bairroLogradouro" style="display: none;">
                                <label for="bairro">Córrego:</label>
                                <input type="text" id="bairro" placeholder="Nome do córrego" maxlength="30">
                            </div>
                        </div>
                        <!-- Quarta linha: Endereço, N°, Bairro (condicional) -->
                        <div id="enderecoRow" style="display: grid; grid-template-columns: 3fr 1fr 2fr; gap: 20px; margin-bottom: 20px;" class="endereco-row">
                            <div class="form-group">
                                <label for="endereco">Endereço:</label>
                                <input type="text" id="endereco" placeholder="Nome da rua, avenida, etc." maxlength="60">
                            </div>
                            <div class="form-group">
                                <label for="numero">N°:</label>
                                <input type="text" id="numero" placeholder="Número" maxlength="4">
                            </div>
                            <div class="form-group" id="bairroEndereco">
                                <label for="bairroUrbano">Bairro:</label>
                                <input type="text" id="bairroUrbano" placeholder="Nome do bairro" maxlength="30">
                            </div>
                        </div>
                        <!-- Quinta linha: Complemento, Telefone -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="complemento">Complemento:</label>
                                <input type="text" id="complemento" placeholder="Apto, bloco, etc." maxlength="30">
                            </div>
                            <div class="form-group">
                                <label for="telefone">Teletelefone:</label>
                                <input type="text" id="telefone" placeholder="(00) 00000-0000" maxlength="15">
                            </div>
                        </div>
                    </fieldset>

                    <!-- PROCEDIMENTO REALIZADO -->
                    <fieldset style="border: 2px solid #27ae60; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <legend style="color: #27ae60; font-weight: bold; padding: 0 10px;">PROCEDIMENTO REALIZADO</legend>
                        <!-- Nova linha: Data, Local, Cidade -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="serviceDate">Data Atend.:</label>
                                <input type="date" id="serviceDate">
                            </div>
                            <div class="form-group">
                                <label for="local">Local:</label>
                                <input type="text" id="local" placeholder="Local do atendimento" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="cidade">Cidade:</label>
                                <select id="cidade">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                        <!-- Segunda linha: Horário, Tipo de Atendimento -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="horario">Horário:</label>
                                <input type="time" id="horario">
                            </div>
                            <div class="form-group">
                                <label for="tipoAtendimento">Tipo Atend.:</label>
                                <select id="tipoAtendimento">
                                    <option value="">Selecione</option>
                                    <option value="acompanhante">Acompanhante</option>
                                    <option value="carona">Carona</option>
                                    <option value="paciente">Paciente</option>
                                    <option value="particular">Particular</option>
                                    <option value="visita">Visita</option>
                                </select>
                            </div>
                        </div>
                        <!-- Campo: Paciente Principal (aparece apenas se tipoAtendimento for "acompanhante") -->
                        <div class="form-group" id="parentPatientGroup" style="display: none; position: relative;">
                            <label for="parentPatientSearch">Paciente Principal (Pesquisar):</label>
                            <input type="text" id="parentPatientSearch" placeholder="Digite para pesquisar pacientes..." autocomplete="off">
                            <input type="hidden" id="parentPatientId" name="parentPatientId">
                            <div id="parentPatientSearchResults" class="search-results-dropdown">
                                <!-- Resultados da pesquisa serão inseridos aqui -->
                            </div>
                        </div>
                    </fieldset>

                    <!-- TRANSPORTE -->
                    <fieldset style="border: 2px solid #e67e22; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <legend style="color: #e67e22; font-weight: bold; padding: 0 10px;">TRANSPORTE</legend>
                        
                        <!-- Botões de tipo de transporte -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <button type="button" class="transport-btn" data-value="cisverde">
                                Ônibus CISVERDE
                            </button>
                            <button type="button" class="transport-btn" data-value="carros_saude">
                                Carros da Saúde
                            </button>
                        </div>
                        
                        <!-- Campos para Motorista e Hora de Saída (visíveis para ambos os transportes) -->
                        <div id="transportSpecificFields" style="display: none; margin-top: 20px;">
                            <div class="grid">
                                <div class="form-group">
                                    <label for="motorista">Motorista:</label>
                                    <input type="text" id="motorista" placeholder="Nome do motorista (opcional)" maxlength="50">
                                </div>
                                <div class="form-group">
                                    <label for="horaSaida">Hora de Saída:</label>
                                    <input type="time" id="horaSaida" placeholder="Hora de saída (opcional)">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- OBSERVAÇÃO -->
                    <fieldset style="border: 2px solid #9b59b6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <legend style="color: #9b59b6; font-weight: bold; padding: 0 10px;">OBSERVAÇÃO</legend>
                        <div class="form-group">
                            <label for="observacao">Observação:</label>
                            <textarea id="observacao" placeholder="Observações gerais (opcional)" maxlength="300" rows="3"></textarea>
                        </div>
                    </fieldset>

                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <button type="button" id="submitBtn" class="btn btn-primary">✅ Salvar Cadastro</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">🔄 Limpar Formulário</button>
                    </div>
                </form>
            </div>

            <!-- Seção de Operações -->
            <div class="card">
                <h2>🔧 Operações</h2>
                
                <!-- VALIDAÇÃO E ANÁLISE -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #27ae60; font-size: 1.1em; margin-bottom: 15px; border-left: 4px solid #27ae60; padding-left: 10px;">🔍 Validação e Análise</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn btn-primary" onclick="validateData()">✅ Validar Dados</button>
                        <button class="btn btn-primary" onclick="toggleStatistics()">📊 Ver Estatísticas</button>
                        <!-- BOTÃO DE RELATÓRIOS QUE ABRE O MODAL DE RELATÓRIOS EXISTENTE -->
                        <button class="btn btn-primary" onclick="openReportModal()">📋 Relatórios</button>
                    </div>
                </div>
                
                <!-- CONFIGURAÇÕES -->
                <div>
                    <h3 style="color: #e67e22; font-size: 1.1em; margin-bottom: 15px; border-left: 4px solid #e67e22; padding-left: 10px;">⚙️ Administração</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn btn-secondary" onclick="openConfigModal()">⚙️ Configurações</button>
                    </div>
                </div>
            </div>

            <!-- Seção de Registros Processados (Tabela de Dados) -->
            <div class="card">
                <h2>📋 Registros Processados</h2>
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Data Cadastro</th>
                                <th>Nome</th>
                                <th>CNS/CPF</th>
                                <th>Sexo</th>
                                <th>Data Nasc.</th>
                                <th>Nacionalidade</th>
                                <th>Raça/Cor</th>
                                <th>Etnia</th>
                                <th>Logradouro</th>
                                <th>Cod Logradouro</th>
                                <th>Endereço</th>
                                <th>N°</th>
                                <th>Bairro/Córrego</th>
                                <th>Complemento</th>
                                <th>Telefone</th>
                                <th>Data Atend.</th>
                                <th>Local</th>
                                <th>Cidade</th>
                                <th>Distância (KM)</th>
                                <th>Procedimentos</th>
                                <th>Horário</th>
                                <th>Tipo Atend.</th>
                                <th>Tipo Atend. Cód.</th>
                                <th>Transporte</th>
                                <th>Motorista</th>
                                <th>Hora Saída</th>
                                <th>Paciente Principal</th>
                                <th>Acompanhantes Vinculados</th>
                                <th>Observação</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="31" class="loading">Nenhum dado carregado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Seção de Log de Validação -->
            <div class="card">
                <h2>📝 Log de Validação</h2>
                <textarea id="logArea" rows="10" placeholder="Logs de validação aparecerão aqui..." readonly></textarea>
            </div>
        </div>

        <!-- Container para as mensagens Toast -->
        <div id="toastContainer"></div>

        <script>
            // Log para depuração, indica que o script foi carregado
            console.log("Script carregado com sucesso!");

            // Variáveis globais para armazenar dados e estado da aplicação
            let bpaData = []; // Armazena todos os registros BPA-I
            let validationLog = []; // Armazena mensagens de log
            let customCities = []; // Armazena cidades personalizadas
            let editingIndex = -1; // Índice do registro sendo editado (-1 se nenhum)
            let editingCityIndex = -1; // NOVO: Índice da cidade sendo editada (-1 se nenhuma)
            let currentReportType = 'complete'; // Tipo de relatório atual (completo, cisverde, carros_saude)
            let allPatientsForSearch = []; // Armazena todos os registros de 'paciente' para a funcionalidade de busca
            let recordToDeleteIndex = -1; // Índice do registro a ser excluído
            let cityToDeleteIndex = -1; // Índice da cidade a ser excluída
            let importFileToProcess = null; // Armazena o arquivo para importação multi-step (para CSV)
            let importCurrentStep = 0; // Controla a etapa atual do modal de importação (para CSV)
            let jsonFileToProcess = null; // Armazena o arquivo JSON para importação
            let jsonImportCurrentStep = 0; // Controla a etapa atual do modal de importação JSON


            // Constantes para a cidade de origem e chave da API de mapas (vazia, será preenchida pelo ambiente Canvas)
            const ORIGIN_CITY_NAME = "Pedra Bonita";
            const ORIGIN_CITY_STATE = "MG";
            const ORIGIN_CITY_FULL = `${ORIGIN_CITY_NAME}, ${ORIGIN_CITY_STATE}`;
            // A chave da API do Google Maps será fornecida pelo ambiente Canvas em tempo de execução
            const GOOGLE_MAPS_API_KEY = typeof __google_maps_api_key !== 'undefined' ? __google_maps_api_key : '';

            // Estrutura padrão do BPA-I para importação de arquivos de texto (posições e tamanhos de campo)
            const BPA_I_STRUCTURE = {
                tipoDado: { pos: 1, len: 2 },
                cnsPaciente: { pos: 3, len: 15 },
                dtNascimento: { pos: 18, len: 8 },
                sexo: { pos: 26, len: 1 },
                raca: { pos: 27, len: 2 },
                municipio: { pos: 29, len: 6 },
                cnes: { pos: 35, len: 7 },
                cbo: { pos: 42, len: 6 },
                dtAtendimento: { pos: 48, len: 8 },
                procedimento: { pos: 56, len: 10 },
                quantidade: { pos: 66, len: 2 },
                caraAtendimento: { pos: 68, len: 2 },
                origem: { pos: 70, len: 1 }
            };

            /**
             * Gera um ID único (UUID v4 simplificado) para cada registro.
             * @returns {string} Um ID único.
             */
            function generateUniqueId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            /**
             * Escapa caracteres HTML de uma string para prevenir XSS e problemas de sintaxe em template literals.
             * @param {string} unsafe - A string a ser escapada.
             * @returns {string} A string com caracteres HTML escapados.
             */
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') {
                    unsafe = String(unsafe);
                }
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/`/g, "&#96;"); // Escapa crase
            }

            // --- Funções de Gerenciamento de Cidades ---

            /**
             * Atualiza o dropdown de seleção de cidades no formulário.
             * As cidades são carregadas de `customCities` e ordenadas alfabeticamente.
             */
            function updateCitySelect() {
                const citySelect = document.getElementById('cidade');
                citySelect.innerHTML = '<option value="">Selecione</option>'; // Limpa e adiciona opção padrão
                customCities.sort((a, b) => a.name.localeCompare(b.name)).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                });
            }

            /**
             * Exibe as cidades cadastradas na tabela de gerenciamento de cidades.
             */
            function displayCities() {
                const tbody = document.getElementById('citiesTableBody');
                tbody.innerHTML = ''; // Limpa o corpo da tabela

                if (customCities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">Nenhuma cidade cadastrada</td></tr>';
                    return;
                }

                customCities.sort((a, b) => a.name.localeCompare(b.name)).forEach((city, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${escapeHtml(city.name)}</td>
                        <td>${escapeHtml(city.km)}</td>
                        <td>${escapeHtml(city.procedures)}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="editCity(${index})" title="Editar Cidade">✏️</button>
                            <button class="btn-action btn-delete" onclick="showCityDeleteConfirmModal(${index})" title="Remover Cidade">🗑️</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            /**
             * Adiciona uma nova cidade ou atualiza uma existente.
             * Verifica `editingCityIndex` para determinar a operação.
             */
            function saveOrUpdateCity() {
                const cityNameInput = document.getElementById('cityName');
                const cityKmInput = document.getElementById('cityKm');
                const cityProceduresInput = document.getElementById('cityProcedures');

                const cityName = cityNameInput.value.trim();
                const cityKm = parseInt(cityKmInput.value);
                const cityProcedures = parseInt(cityProceduresInput.value);

                // Validação de campos
                if (!cityName || isNaN(cityKm) || isNaN(cityProcedures)) {
                    showToast('Por favor, preencha todos os campos da cidade corretamente.', 'error');
                    return;
                }

                // Verifica se a cidade já existe (apenas para adição, ou se o nome mudou durante a edição)
                const existingCity = customCities.find((c, idx) => 
                    c.name.toLowerCase() === cityName.toLowerCase() && idx !== editingCityIndex
                );
                if (existingCity) {
                    showToast('Esta cidade já está cadastrada.', 'warning');
                    return;
                }

                if (editingCityIndex !== -1) {
                    // Modo de edição
                    customCities[editingCityIndex].name = cityName;
                    customCities[editingCityIndex].km = cityKm;
                    customCities[editingCityIndex].procedures = cityProcedures;
                    addLog(`Cidade atualizada: ${cityName} (${cityKm} KM, ${cityProcedures} procedimentos)`);
                    showToast(`Cidade "${cityName}" atualizada com sucesso!`, 'success');
                } else {
                    // Modo de adição
                    customCities.push({ name: cityName, km: cityKm, procedures: cityProcedures });
                    addLog(`Cidade adicionada: ${cityName} (${cityKm} KM, ${cityProcedures} procedimentos)`);
                    showToast(`Cidade "${cityName}" adicionada com sucesso!`, 'success');
                }

                saveCitiesToStorage();
                updateCitySelect();
                displayCities();
                clearCityForm(); // Limpa o formulário e reseta o modo de edição
            }

            /**
             * Preenche o formulário de cidade com os dados da cidade selecionada para edição.
             * @param {number} index - O índice da cidade a ser editada.
             */
            function editCity(index) {
                editingCityIndex = index;
                const city = customCities[index];

                document.getElementById('cityName').value = city.name;
                document.getElementById('cityKm').value = city.km;
                document.getElementById('cityProcedures').value = city.procedures;

                document.getElementById('saveCityBtn').textContent = '✅ Salvar Alterações';
                showToast(`Editando cidade: "${city.name}"`, 'info');

                // Rola para o formulário de edição
                document.getElementById('citiesModal').querySelector('h3').scrollIntoView({ behavior: 'smooth' });
            }

            /**
             * Limpa os campos do formulário de adição/edição de cidade e reseta o modo de edição.
             */
            function clearCityForm() {
                document.getElementById('cityName').value = '';
                document.getElementById('cityKm').value = '';
                document.getElementById('cityProcedures').value = '';
                
                editingCityIndex = -1; // Reseta o índice de edição
                document.getElementById('saveCityBtn').textContent = '➕ Adicionar Cidade'; // Restaura o texto do botão
                showToast('Formulário de cidade limpo / Edição cancelada.', 'info');
            }

            /**
             * Calcula a distância real e procedimentos para uma cidade usando a Google Maps Distance Matrix API.
             */
            async function calculateDistanceAndProcedures() {
                const cityNameInput = document.getElementById('cityName');
                const cityKmInput = document.getElementById('cityKm');
                const cityProceduresInput = document.getElementById('cityProcedures');

                const destinationCity = cityNameInput.value.trim();

                if (!destinationCity) {
                    showToast('Por favor, digite o nome da cidade destino.', 'warning');
                    return;
                }

                if (!GOOGLE_MAPS_API_KEY) {
                    showToast('Chave da API do Google Maps não configurada. Não é possível calcular a distância real.', 'error');
                    addLog('ERRO: Chave da API do Google Maps ausente.');
                    return;
                }

                // Mostra um indicador de carregamento
                cityKmInput.value = 'Calculando...';
                cityProceduresInput.value = 'Calculando...';
                showToast('Calculando distância...', 'info', 5000);

                const origins = encodeURIComponent(ORIGIN_CITY_FULL);
                const destinations = encodeURIComponent(`${destinationCity}, Brasil`); // Adiciona "Brasil" para melhor precisão
                const apiUrl = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${origins}&destinations=${destinations}&key=${GOOGLE_MAPS_API_KEY}`;

                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.status === 'OK' && data.rows.length > 0 && data.rows[0].elements.length > 0) {
                        const element = data.rows[0].elements[0];

                        if (element.status === 'OK') {
                            const distanceMeters = element.distance.value; // Distância em metros
                            const distanceKm = Math.round(distanceMeters / 1000); // Converte para KM e arredonda
                            const procedures = Math.floor(distanceKm / 50); // 1 procedimento a cada 50km

                            cityKmInput.value = distanceKm;
                            cityProceduresInput.value = procedures;
                            showToast(`Distância calculada: ${distanceKm} KM.`, 'success');
                            addLog(`Distância calculada para ${destinationCity}: ${distanceKm} KM.`);
                        } else {
                            showToast(`Não foi possível calcular a distância para "${destinationCity}". Status: ${element.status}`, 'error');
                            addLog(`ERRO ao calcular distância para ${destinationCity}: ${element.status}`);
                            cityKmInput.value = 'Erro';
                            cityProceduresInput.value = 'Erro';
                        }
                    } else {
                        showToast(`Não foi possível encontrar a cidade "${destinationCity}". Verifique o nome.`, 'error');
                        addLog(`ERRO: Cidade "${destinationCity}" não encontrada pela API. Status: ${data.status}`);
                        cityKmInput.value = 'Não encontrada';
                        cityProceduresInput.value = 'Não encontrada';
                    }
                } catch (error) {
                    showToast('Erro ao conectar com a API de mapas. Verifique sua conexão ou a chave da API.', 'error');
                    addLog(`ERRO na requisição da API de mapas: ${error.message}`);
                    cityKmInput.value = 'Erro';
                    cityProceduresInput.value = 'Erro';
                }
            }

            /**
             * Importa cidades de um arquivo CSV.
             * O arquivo deve ter o formato "Nome;KM;Procedimentos" por linha.
             */
            function importCities() {
                const fileInput = document.getElementById('importCitiesFile');
                if (!fileInput.files || fileInput.files.length === 0) {
                    showToast('Nenhum arquivo selecionado para importação de cidades.', 'warning');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim());
                    let importedCount = 0;
                    let errorCount = 0;

                    lines.forEach(line => {
                        const parts = line.split(';');
                        if (parts.length >= 3) {
                            const name = parts[0].trim();
                            const km = parseInt(parts[1].trim());
                            const procedures = parseInt(parts[2].trim());

                            if (name && !isNaN(km) && !isNaN(procedures)) {
                                if (!customCities.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                                    customCities.push({ name, km, procedures });
                                    importedCount++;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    });

                    saveCitiesToStorage();
                    updateCitySelect();
                    displayCities();
                    addLog(`Importação de cidades concluída: ${importedCount} novas cidades, ${errorCount} erros.`);
                    showToast(`Importação de cidades concluída: ${importedCount} novas cidades.`, importedCount > 0 ? 'success' : 'info');
                };
                reader.readAsText(file);
            }

            /**
             * Escapa campos CSV para garantir que caracteres especiais não quebrem o formato.
             * @param {any} field - O valor do campo a ser escapado.
             * @returns {string} O campo escapado para CSV.
             */
            function escapeCsvField(field) {
                if (field === null || field === undefined) return '';
                let stringField = String(field);
                // Se o campo contiver o delimitador, aspas duplas ou quebra de linha, envolva-o em aspas
                if (stringField.includes(';') || stringField.includes('"') || stringField.includes('\n') || stringField.includes('\r')) {
                    // Escapa aspas duplas dentro do campo (dobra-as)
                    stringField = stringField.replace(/"/g, '""');
                    return `"${stringField}"`;
                }
                return stringField;
            }

            /**
             * Exporta as cidades cadastradas para um arquivo CSV.
             */
            function exportCities() {
                if (customCities.length === 0) {
                    showToast('Nenhuma cidade para exportar.', 'info');
                    return;
                }
                const BOM = '\uFEFF'; // Byte Order Mark para UTF-8 (garante compatibilidade com Excel)
                const headers = ['Nome', 'KM', 'Procedimentos'];
                let csvContent = BOM + headers.join(';') + '\n';
                customCities.forEach(city => {
                    csvContent += `${escapeCsvField(city.name)};${escapeCsvField(city.km)};${escapeCsvField(city.procedures)}\n`;
                });
                downloadFile('cidades_cadastradas.csv', csvContent);
                addLog('Cidades exportadas para CSV.');
                showToast('Cidades exportadas com sucesso!', 'success');
            }

            /**
             * Cria um backup dos dados atuais da aplicação (registros BPA-I, cidades e logs) em um arquivo JSON.
             * @param {string} actionType - Tipo de ação que motivou o backup (ex: 'MANUAL', 'IMPORTACAO', 'EXCLUSAO').
             */
            function createBackup(actionType = 'MANUAL') {
                const now = new Date();
                const timestamp = now.toISOString().slice(0,19).replace(/[-:T]/g, '').replace(/\..+/, '');
                const backupData = {
                    bpaData: bpaData,
                    customCities: customCities,
                    validationLog: validationLog,
                    timestamp: now.toLocaleString('pt-BR'),
                    action: actionType
                };
                const backupJson = JSON.stringify(backupData, null, 2);
                downloadFile(`bpa_backup_${timestamp}_${actionType}.json`, backupJson);
                addLog(`Backup gerado (${actionType}).`);
            }

            // --- Funções Auxiliares de Formatação e Validação ---

            /**
             * Converte uma string de data de DD/MM/AAAA ou DD-MM-AAAA para DDMMAAAA.
             * @param {string} dateString - A string de data a ser convertida.
             * @returns {string} A data no formato DDMMAAAA.
             */
            function convertDateToInternal(dateString) {
                if (!dateString) return '';
                const parts = dateString.replace(/[-.]/g, '/').split('/');
                if (parts.length === 3) {
                    return `${parts[0]}${parts[1]}${parts[2]}`;
                }
                return dateString; // Retorna original se não for o formato esperado
            }

            /**
             * Formata uma string de CNS/CPF enquanto o usuário digita.
             * Adiciona pontos, barras ou espaços conforme o tipo (CPF ou CNS).
             * @param {Event} event - O evento de input.
             */
            function handleCNSInput(event) {
                const input = event.target;
                let value = input.value.replace(/\D/g, ''); // Remove caracteres não numéricos
                const indicator = document.getElementById('cnsTypeIndicator');
                
                if (value.length <= 11) {
                    // Formatação CPF: 000.000.000-00
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    if (value.replace(/\D/g, '').length === 11) {
                        indicator.textContent = 'Formato: CPF';
                        indicator.style.color = '#3498db';
                    } else if (value.replace(/\D/g, '').length > 0) {
                        indicator.textContent = 'Digite CPF ou CNS';
                        indicator.style.color = '#f39c12';
                    } else {
                        indicator.textContent = '';
                    }
                } else {
                    // Formatação CNS: 000 0000 0000 0000
                    value = value.substring(0, 15); // Limita a 15 dígitos
                    value = value.replace(/(\d{3})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
                    if (value.replace(/\D/g, '').length === 15) {
                        indicator.textContent = 'Formato: CNS';
                        indicator.style.color = '#3498db';
                    } else {
                        indicator.textContent = 'Digite os 15 dígitos do CNS';
                        indicator.style.color = '#f39c12';
                    }
                }
                input.value = value;
            }
            
            /**
             * Valida o CNS ou CPF ao sair do campo e atualiza o indicador de status.
             * @param {Event} event - O evento de blur.
             */
            function validateCNSField(event) {
                const input = event.target;
                const cleanValue = input.value.replace(/\D/g, '');
                
                if (cleanValue.length === 11) {
                    if (!isValidCPF(cleanValue)) {
                        input.style.borderColor = '#e74c3c';
                        document.getElementById('cnsTypeIndicator').textContent = 'CPF inválido';
                        document.getElementById('cnsTypeIndicator').style.color = '#e74c3c';
                    } else {
                        input.style.borderColor = '#27ae60';
                        document.getElementById('cnsTypeIndicator').textContent = 'CPF válido';
                        document.getElementById('cnsTypeIndicator').style.color = '#27ae60';
                    }
                } else if (cleanValue.length === 15) {
                    if (!isValidCNS(cleanValue)) {
                        input.style.borderColor = '#e74c3c';
                        document.getElementById('cnsTypeIndicator').textContent = 'CNS inválido';
                        document.getElementById('cnsTypeIndicator').style.color = '#e74c3c';
                    } else {
                        input.style.borderColor = '#27ae60';
                        document.getElementById('cnsTypeIndicator').textContent = 'CNS válido';
                        document.getElementById('cnsTypeIndicator').style.color = '#27ae60';
                    }
                } else if (cleanValue.length > 0) {
                    input.style.borderColor = '#f39c12';
                    if (cleanValue.length < 11) {
                        document.getElementById('cnsTypeIndicator').textContent = 'CPF incompleto';
                    } else {
                        document.getElementById('cnsTypeIndicator').textContent = 'CNS incompleto';
                    }
                    document.getElementById('cnsTypeIndicator').style.color = '#f39c12';
                } else {
                    input.style.borderColor = '#ecf0f1';
                    document.getElementById('cnsTypeIndicator').textContent = '';
                }
            }
            
            /**
             * Valida um número de CPF.
             * @param {string} cpf - O CPF a ser validado (apenas dígitos).
             * @returns {boolean} True se o CPF for válido, false caso contrário.
             */
            function isValidCPF(cpf) {
                if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
                
                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf[i]) * (10 - i);
                }
                let digit1 = 11 - (sum % 11);
                if (digit1 > 9) digit1 = 0;
                
                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf[i]) * (11 - i);
                }
                let digit2 = 11 - (sum % 11);
                if (digit2 > 9) digit2 = 0;
                
                return digit1 === parseInt(cpf[9]) && digit2 === parseInt(cpf[10]);
            }
            
            /**
             * Valida um número de CNS (Cartão Nacional de Saúde).
             * @param {string} cns - O CNS a ser validado (apenas dígitos).
             * @returns {boolean} True se o CNS for válido, false caso contrário.
             */
            function isValidCNS(cns) {
                if (!cns || cns.length !== 15 || !/^\d+$/.test(cns)) {
                    return false;
                }
                
                // Algoritmo de validação do CNS
                const weights1 = [15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1];
                let sum = 0;
                
                for (let i = 0; i < 15; i++) {
                    sum += parseInt(cns[i]) * weights1[i];
                }
                
                return sum % 11 === 0;
            }
            
            /**
             * Valida se uma string é um CNS ou CPF válido.
             * @param {string} value - A string contendo o CNS ou CPF.
             * @returns {boolean} True se for um CNS ou CPF válido, false caso contrário.
             */
            function isValidCNSOrCPF(value) {
                const cleanValue = value.replace(/\D/g, '');
                if (cleanValue.length === 11) {
                    return isValidCPF(cleanValue);
                } else if (cleanValue.length === 15) {
                    return isValidCNS(cleanValue);
                }
                return false;
            }
            
            /**
             * Formata uma string de telefone enquanto o usuário digita.
             * Adiciona parênteses e hífen.
             * @param {Event} event - O evento de input.
             */
            function handleTelefoneInput(event) {
                const input = event.target;
                let value = input.value.replace(/\D/g, '');
                
                if (value.length <= 11) {
                    if (value.length <= 10) {
                        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                    } else {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    }
                }
                input.value = value;
            }

            /**
             * Transforma o texto de um campo de input para maiúsculas.
             * @param {Event} event - O evento de input.
             */
            function handleNameInput(event) {
                event.target.value = event.target.value.toUpperCase();
            }
            
            /**
             * Lida com a mudança no campo "Logradouro" (Zona Rural/Urbana),
             * ajustando a visibilidade e os rótulos dos campos de endereço/bairro.
             * @param {Event} event - O evento de mudança.
             */
            function handleLogradouroChange(event) {
                const logradouro = event.target.value;
                const logradouroRow = document.getElementById('logradouroRow');
                const enderecoRow = document.getElementById('enderecoRow');
                const bairroLogradouro = document.getElementById('bairroLogradouro');
                const bairroEndereco = document.getElementById('bairroEndereco');
                const bairroInput = document.getElementById('bairro');
                const bairroUrbanoInput = document.getElementById('bairroUrbano');
                
                if (logradouro === '024') { // Zona Rural
                    enderecoRow.style.display = 'none';
                    logradouroRow.style.gridTemplateColumns = 'repeat(3, 1fr)';
                    bairroLogradouro.style.display = 'block';
                    bairroEndereco.style.display = 'none';
                    document.getElementById('endereco').value = '';
                    document.getElementById('numero').value = '';
                    bairroUrbanoInput.value = '';
                } else if (logradouro === '081') { // Área Urbana
                    enderecoRow.style.display = 'grid';
                    logradouroRow.style.gridTemplateColumns = 'repeat(2, 1fr)';
                    bairroLogradouro.style.display = 'none';
                    bairroEndereco.style.display = 'block';
                    bairroInput.value = '';
                } else {
                    // Padrão (quando não selecionado ou valor inválido)
                    enderecoRow.style.display = 'grid';
                    logradouroRow.style.gridTemplateColumns = 'repeat(2, 1fr)';
                    bairroLogradouro.style.display = 'none';
                    bairroEndereco.style.display = 'block';
                }
            }
            
            /**
             * Lida com a mudança no campo "Raça/Cor", mostrando ou ocultando o campo "Etnia".
             * @param {Event} event - O evento de mudança.
             */
            function handleRacaChange(event) {
                const raca = event.target.value;
                const etniaField = document.querySelector('.etnia-field');
                const etniaInput = document.getElementById('etnia');
                
                if (raca === '05') { // Indígena
                    etniaField.style.display = 'block';
                } else {
                    etniaField.style.display = 'none';
                    etniaInput.value = ''; // Limpa o valor quando oculto
                }
            }
            
            /**
             * Lida com a mudança no campo "Tipo de Atendimento", mostrando ou ocultando
             * o campo "Paciente Principal" e validando a idade para acompanhantes.
             * @param {Event} event - O evento de mudança.
             */
            function handleTipoAtendimentoChange(event) {
                const tipoAtendimento = event.target.value;
                const parentPatientGroup = document.getElementById('parentPatientGroup');

                if (tipoAtendimento === 'acompanhante') {
                    const birthDate = document.getElementById('birthDate').value;
                    if (birthDate && !isAdult(birthDate)) {
                        showToast('Acompanhante deve ter 18 anos ou mais. Pessoa menor de idade não pode ser acompanhante.', 'warning');
                        event.target.value = ''; // Limpa a seleção se a idade for inválida
                        return;
                    }
                    parentPatientGroup.style.display = 'block'; 
                    // Limpa pesquisa anterior e paciente selecionado
                    document.getElementById('parentPatientSearch').value = '';
                    document.getElementById('parentPatientId').value = '';
                    document.getElementById('parentPatientSearchResults').innerHTML = '';
                    populateAllPatientsForSearch(); // Atualiza a lista de pacientes para pesquisa imediatamente
                } else {
                    parentPatientGroup.style.display = 'none';
                    document.getElementById('parentPatientSearch').value = '';
                    document.getElementById('parentPatientId').value = '';
                    document.getElementById('parentPatientSearchResults').innerHTML = '';
                }
            }
            
            /**
             * Atualiza as opções do campo "Tipo de Atendimento" com base na idade do paciente.
             * Desabilita "Acompanhante" se o paciente for menor de 18 anos.
             */
            function updateTipoAtendimentoOptions() {
                const birthDate = document.getElementById('birthDate').value;
                const tipoAtendimentoSelect = document.getElementById('tipoAtendimento');
                const acompanhanteOption = tipoAtendimentoSelect.querySelector('option[value="acompanhante"]');
                
                if (birthDate && !isAdult(birthDate)) {
                    acompanhanteOption.disabled = true;
                    acompanhanteOption.textContent = 'Acompanhante (requer +18 anos)';
                    
                    if (tipoAtendimentoSelect.value === 'acompanhante') {
                        tipoAtendimentoSelect.value = '';
                    }
                } else {
                    acompanhanteOption.disabled = false;
                    acompanhanteOption.textContent = 'Acompanhante';
                }
            }
            
            /**
             * Verifica se uma pessoa é adulta (18 anos ou mais) com base na data de nascimento.
             * @param {string} birthDateStr - Data de nascimento no formato YYYY-MM-DD.
             * @returns {boolean} True se a pessoa tiver 18 anos ou mais, false caso contrário.
             */
            function isAdult(birthDateStr) {
                if (!birthDateStr) return false;
                
                const birthDate = new Date(birthDateStr);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--; // Ajusta a idade se o aniversário ainda não ocorreu este ano
                }
                return age >= 18;
            }

            /**
             * Valida se uma string representa uma data válida no formato DDMMAAAA.
             * @param {string} dateStr - A string de data a ser validada.
             * @returns {boolean} True se a data for válida, false caso contrário.
             */
            function isValidDate(dateStr) {
                if (!dateStr || dateStr.length !== 8) return false;
                
                const day = parseInt(dateStr.substring(0, 2));
                const month = parseInt(dateStr.substring(2, 4));
                const year = parseInt(dateStr.substring(4, 8));
                
                if (year < 1900 || year > new Date().getFullYear()) return false;
                if (month < 1 || month > 12) return false;
                
                const date = new Date(year, month - 1, day);
                // Verifica se a data criada corresponde aos valores originais (evita datas como 30 de fevereiro)
                return date.getFullYear() === year && 
                       date.getMonth() === month - 1 && 
                       date.getDate() === day;
            }

            /**
             * Retorna a descrição do tipo de atendimento com base no código.
             * @param {string} tipo - Código do tipo de atendimento.
             * @returns {string} Descrição do tipo de atendimento.
             */
            function getTipoAtendimentoDesc(tipo) {
                switch(tipo) {
                    case 'acompanhante': return 'Acompanhante';
                    case 'carona': return 'Carona';
                    case 'paciente': return 'Paciente';
                    case 'particular': return 'Particular';
                    case 'visita': return 'Visita';
                    default: return '';
                }
            }

            /**
             * Atualiza os contadores de registros (total, válidos, com erro) na seção de estatísticas.
             */
            function updateStatistics() {
                const total = bpaData.length;
                const valid = bpaData.filter(r => r.status === 'valid').length;
                const error = bpaData.filter(r => r.status === 'error').length;

                document.getElementById('totalRecords').textContent = total;
                document.getElementById('validRecords').textContent = valid;
                document.getElementById('errorRecords').textContent = error;
                document.getElementById('totalProcedures').textContent = 'N/A'; // Procedimentos não são mais calculados individualmente
            }

            /**
             * Exibe os dados dos registros BPA-I na tabela principal.
             * Limita a exibição aos 100 registros mais recentes para performance.
             */
            function displayData() {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = ''; // Limpa o corpo da tabela

                if (bpaData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="31" class="loading">Nenhum dado carregado</td></tr>';
                    return;
                }

                // Ordena os dados pelo dtCadastro em ordem decrescente (mais recente primeiro)
                const sortedBpaData = [...bpaData].sort((a, b) => {
                    const parseDateTime = (dateTimeStr) => {
                        if (!dateTimeStr) return 0;
                        const [datePart, timePart] = dateTimeStr.split(', ');
                        const [day, month, year] = datePart.split('/').map(Number);
                        const [hours, minutes, seconds] = timePart.split(':').map(Number);
                        return new Date(year, month - 1, day, hours, minutes, seconds).getTime();
                    };
                    return parseDateTime(b.dtCadastro) - parseDateTime(a.dtCadastro);
                });

                // Cria um mapa para encontrar facilmente acompanhantes para cada paciente principal
                const patientCompanionsMap = new Map();
                sortedBpaData.forEach(record => {
                    if (record.tipoAtendimento === 'acompanhante' && record.parentPatientId) {
                        if (!patientCompanionsMap.has(record.parentPatientId)) {
                            patientCompanionsMap.set(record.parentPatientId, []);
                        }
                        patientCompanionsMap.get(record.parentPatientId).push(record);
                    }
                });

                // Exibe apenas os primeiros 100 registros para melhor performance na UI
                sortedBpaData.slice(0, 100).forEach(record => {
                    const row = document.createElement('tr');
                    const statusClass = record.status === 'valid' ? 'status-success' : 
                                      record.status === 'error' ? 'status-error' : 'status-warning';
                    
                    const parentPatientName = record.parentPatientId ? getPatientNameById(record.parentPatientId) : '';
                    
                    let linkedCompanions = '';
                    if (record.tipoAtendimento === 'paciente' && patientCompanionsMap.has(record.id)) {
                        const companions = patientCompanionsMap.get(record.id);
                        linkedCompanions = companions.map(c => escapeHtml(c.patientId)).join(', ');
                    }

                    row.innerHTML = `
                        <td style="font-size: 0.85em; color: #666;">${escapeHtml(record.dtCadastro || '')}</td>
                        <td>${escapeHtml(record.patientId || '')}</td>
                        <td class="${record.errors.some(e => e.includes('CNS/CPF')) ? 'field-error' : ''}">${escapeHtml(formatCNSForDisplay(record.cnsPaciente) || '')}</td>
                        <td>${escapeHtml(record.sexo === '1' ? 'M' : record.sexo === '2' ? 'F' : '')}</td>
                        <td class="${record.errors.some(e => e.includes('nascimento')) ? 'field-error' : ''}">${escapeHtml(formatDate(record.dtNascimento) || '')}</td>
                        <td>${escapeHtml(getNacionalidadeDesc(record.nacionalidade) || '')}</td>
                        <td>${escapeHtml(getRacaDesc(record.raca) || '')}</td>
                        <td>${escapeHtml(record.etnia || '')}</td>
                        <td>${escapeHtml(getLogradouroDesc(record.codLogradouro) || '')}</td>
                        <td>${escapeHtml(record.codLogradouro || '')}</td>
                        <td>${escapeHtml(record.endereco || '')}</td>
                        <td>${escapeHtml(record.numero || 's/n')}</td>
                        <td>${escapeHtml(record.bairro || '')}</td>
                        <td>${escapeHtml(record.complemento || '')}</td>
                        <td>${escapeHtml(formatTelefoneForDisplay(record.telefone) || '')}</td>
                        <td class="${record.errors.some(e => e.includes('atendimento')) ? 'field-error' : ''}">${escapeHtml(formatDate(record.dtAtendimento) || '')}</td>
                        <td>${escapeHtml(record.local || '')}</td>
                        <td>${escapeHtml(record.cidade || '')}</td>
                        <td>${escapeHtml(record.distanciaKm || '0')} km</td>
                        <td>${escapeHtml(record.totalProcedimentos || '0')}</td>
                        <td>${escapeHtml(record.horario || '')}</td>
                        <td>${escapeHtml(getTipoAtendimentoDesc(record.tipoAtendimento) || '')}</td>
                        <td>${escapeHtml(record.tipoAtendimentoCodigo || '')}</td>
                        <td>${escapeHtml(getTransporteDesc(record.transporte) || '')}</td>
                        <td>${escapeHtml(record.motorista || '')}</td>
                        <td>${escapeHtml(record.horaSaida || '')}</td>
                        <td>${escapeHtml(parentPatientName)}</td>
                        <td>${escapeHtml(linkedCompanions)}</td>
                        <td>${escapeHtml(record.observacao || '')}</td>
                        <td>
                            <span class="status-indicator ${statusClass}">${escapeHtml(record.status)}</span>
                            ${record.errors.length > 0 ? `<div class="error-details" title="${escapeHtml(record.errors.join(', '))}">⚠️</div>` : ''}
                        </td>
                        <td>
                            <button class="btn-action btn-edit" onclick="editRecord(${bpaData.indexOf(record)})" title="Editar">✏️</button>
                            <button class="btn-action btn-delete" onclick="showDeleteConfirmModal(${bpaData.indexOf(record)})" title="Excluir">🗑️</button>
                        </td>
                    `;
                    
                    if (record.errors.length > 0) {
                        row.title = 'Erros: ' + escapeHtml(record.errors.join(', '));
                    }
                    
                    tbody.appendChild(row);
                });

                if (bpaData.length > 100) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="31" class="loading">... e mais ${bpaData.length - 100} registros</td>`;
                    tbody.appendChild(row);
                }
            }

            /**
             * Formata uma string de data DDMMAAAA para DD/MM/AAAA para exibição.
             * @param {string} dateStr - A string de data no formato DDMMAAAA.
             * @returns {string} A data formatada para exibição.
             */
            function formatDate(dateStr) {
                if (!dateStr || dateStr.length !== 8) return dateStr;
                return `${dateStr.substring(0,2)}/${dateStr.substring(2,4)}/${dateStr.substring(4,8)}`;
            }

            /**
             * Formata uma string de data DDMMAAAA para YYYY-MM-DD para uso em inputs de tipo 'date'.
             * @param {string} dateStr - A string de data no formato DDMMAAAA.
             * @returns {string} A data formatada para input.
             */
            function formatDateForInput(dateStr) {
                if (!dateStr || dateStr.length !== 8) return '';
                return `${dateStr.substring(4,8)}-${dateStr.substring(2,4)}-${dateStr.substring(0,2)}`;
            }
            
            /**
             * Formata uma string de CNS (15 dígitos) ou CPF (11 dígitos) para exibição com pontuação.
             * @param {string} cns - O CNS ou CPF (apenas dígitos).
             * @returns {string} O CNS/CPF formatado.
             */
            function formatCNSForDisplay(cns) {
                if (!cns) return '';
                const clean = cns.replace(/\D/g, '');
                if (clean.length === 11) {
                    return clean.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (clean.length === 15) {
                    return clean.replace(/(\d{3})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
                }
                return clean;
            }
            
            /**
             * Formata uma string de telefone para exibição com parênteses e hífen.
             * @param {string} telefone - O número de telefone (apenas dígitos).
             * @returns {string} O telefone formatado.
             */
            function formatTelefoneForDisplay(telefone) {
                if (!telefone) return '';
                const clean = telefone.replace(/\D/g, '');
                if (clean.length === 10) {
                    return clean.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else if (clean.length === 11) {
                    return clean.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                return clean;
            }

            /**
             * Retorna a descrição do sexo com base no código.
             * @param {string} sexo - Código do sexo ('1' para Masculino, '2' para Feminino).
             * @returns {string} Descrição do sexo.
             */
            function getSexoDescription(sexo) {
                switch(sexo) {
                    case '1': return 'Masculino';
                    case '2': return 'Feminino';
                    default: return '';
                }
            }
            
            /**
             * Retorna a descrição da nacionalidade com base no código.
             * @param {string} codigo - Código da nacionalidade.
             * @returns {string} Descrição da nacionalidade.
             */
            function getNacionalidadeDesc(codigo) {
                switch(codigo) {
                    case '010': return 'Brasileira';
                    case '020': return 'Naturalizado';
                    case '030': return 'Estrangeiro';
                    default: return '';
                }
            }
            
            /**
             * Retorna a descrição da raça/cor com base no código.
             * @param {string} codigo - Código da raça/cor.
             * @returns {string} Descrição da raça/cor.
             */
            function getRacaDesc(codigo) {
                switch(codigo) {
                    case '01': return 'Branca';
                    case '02': return 'Preta';
                    case '03': return 'Parda';
                    case '04': return 'Amarela';
                    case '05': return 'Indígena';
                    case '99': return 'Sem Info';
                    default: return '';
                }
            }
            
            /**
             * Retorna o código da raça/cor a partir de uma string de texto.
             * @param {string} raca - Texto da raça/cor.
             * @returns {string} Código da raça/cor.
             */
            function getRacaCodeFromText(raca) {
                if (!raca) return '';
                const r = raca.toLowerCase();
                if (r.includes('branca')) return '01';
                if (r.includes('preta')) return '02';
                if (r.includes('parda')) return '03';
                if (r.includes('amarela')) return '04';
                if (r.includes('indígena')) return '05';
                return '99';
            }

            /**
             * Retorna a descrição do logradouro com base no código.
             * @param {string} codigo - Código do logradouro.
             * @returns {string} Descrição do logradouro.
             */
            function getLogradouroDesc(codigo) {
                switch(codigo) {
                    case '081': return 'Urbana';
                    case '024': return 'Rural';
                    default: return '';
                }
            }
            
            /**
             * Retorna a descrição do tipo de transporte com base no código.
             * @param {string} tipo - Código do tipo de transporte.
             * @returns {string} Descrição do tipo de transporte.
             */
            function getTransporteDesc(tipo) {
                switch(tipo) {
                    case 'cisverde': return 'Ônibus CISVERDE';
                    case 'carros_saude': return 'Carros da Saúde';
                    case 'acompanhante': return 'Acompanhante'; // Embora seja tipo de atendimento, pode aparecer aqui
                    case 'carona': return 'Carona';
                    case 'paciente': return 'Paciente';
                    case 'particular': return 'Particular';
                    case 'visita': return 'Visita';
                    default: return '';
                }
            }
            
            /**
             * Retorna o código do tipo de atendimento com base no tipo.
             * @param {string} tipo - Tipo de atendimento (ex: 'acompanhante', 'paciente').
             * @returns {string} Código do tipo de atendimento.
             */
            function getTipoAtendimentoCodigo(tipo) {
                switch(tipo) {
                    case 'acompanhante': return '08.03.01.010-9';
                    case 'paciente': return '08.03.01.012-5';
                    default: return '';
                }
            }

            /**
             * Retorna o tipo de atendimento a partir de uma string de texto.
             * @param {string} tipo - Texto do tipo de atendimento.
             * @returns {string} Tipo de atendimento.
             */
            function getTipoAtendimentoFromText(tipo) {
                if (!tipo) return '';
                const t = tipo.toLowerCase();
                if (t.includes('acompanhante')) return 'acompanhante';
                if (t.includes('carona')) return 'carona';
                if (t.includes('particular')) return 'particular';
                if (t.includes('visita')) return 'visita';
                return 'paciente'; // Padrão se não for reconhecido
            }
            
            /**
             * Retorna o tipo de transporte a partir de uma string de texto.
             * @param {string} transporte - Texto do tipo de transporte.
             * @returns {string} Tipo de transporte.
             */
            function getTransporteFromText(transporte) {
                if (!transporte) return '';
                const t = transporte.toLowerCase();
                if (t.includes('cisverde') || t.includes('ônibus')) return 'cisverde';
                if (t.includes('carros') || t.includes('saúde')) return 'carros_saude';
                return '';
            }
            
            /**
             * Retorna os dados de KM e Procedimentos de uma cidade.
             * @param {string} cityName - Nome da cidade.
             * @returns {{km: number, procedures: number}} Objeto com KM e Procedimentos.
             */
            function getCityData(cityName) {
                const city = customCities.find(c => c.name.toLowerCase() === cityName.toLowerCase());
                return city ? { km: city.km, procedures: city.procedures } : { km: 0, procedures: 0 };
            }

            // --- Funções de Persistência de Dados (localStorage) ---

            /** Salva as cidades personalizadas no localStorage. */
            function saveCitiesToStorage() {
                localStorage.setItem('bpa_cities', JSON.stringify(customCities));
            }
            
            /** Carrega as cidades personalizadas do localStorage. */
            function loadCitiesFromStorage() {
                const stored = localStorage.getItem('bpa_cities');
                try {
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            customCities = parsed;
                        } else {
                            console.warn("Dados de cidades armazenados não são um array, inicializando como vazio.");
                            customCities = [];
                        }
                    } else {
                        customCities = []; // Inicializa se nada estiver armazenado
                    }
                } catch (e) {
                    console.error("Erro ao analisar dados de cidades armazenados:", e);
                    customCities = []; // Fallback para array vazio em caso de erro
                }
                updateCitySelect();
            }
            
            /** Salva os dados BPA-I, logs e índice de edição no localStorage. */
            function saveDataToStorage() {
                localStorage.setItem('bpa_data', JSON.stringify(bpaData));
                localStorage.setItem('bpa_logs', JSON.stringify(validationLog));
                localStorage.setItem('editing_index', editingIndex.toString());
            }
            
            /** Carrega os dados BPA-I, logs e índice de edição do localStorage. */
            function loadDataFromStorage() {
                const storedData = localStorage.getItem('bpa_data');
                const storedLogs = localStorage.getItem('bpa_logs');
                const storedEditingIndex = localStorage.getItem('editing_index');

                try {
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        if (Array.isArray(parsedData)) {
                            // Garante que a propriedade 'errors' de cada registro seja um array
                            bpaData = parsedData.map(record => ({
                                ...record,
                                errors: Array.isArray(record.errors) ? record.errors : []
                            }));
                        } else {
                            console.warn("Dados BPA armazenados não são um array, inicializando como vazio.");
                            bpaData = [];
                        }
                    } else {
                        bpaData = [];
                    }
                } catch (e) {
                    console.error("Erro ao analisar dados BPA armazenados:", e);
                    bpaData = [];
                }

                if (storedLogs) {
                    try {
                        const parsedLogs = JSON.parse(storedLogs);
                        if (Array.isArray(parsedLogs)) {
                            validationLog = parsedLogs;
                        } else {
                            console.warn("Dados de log armazenados não são um array, inicializando como vazio.");
                            validationLog = [];
                        }
                    } catch (e) {
                        console.error("Erro ao analisar dados de log armazenados:", e);
                        validationLog = [];
                    }
                    document.getElementById('logArea').value = validationLog.join('\n');
                } else {
                    validationLog = [];
                }

                if (storedEditingIndex && storedEditingIndex !== '-1') {
                    editingIndex = parseInt(storedEditingIndex);
                    if (editingIndex >= 0 && editingIndex < bpaData.length) {
                        updateSubmitButton(true); // Restaura o estado de edição
                        addLog(`Estado de edição restaurado para registro ${editingIndex + 1}`);
                    }
                }

                updateStatistics();
                displayData();
                populateAllPatientsForSearch();
            }
            
            /** Limpa todos os dados do sistema (registros BPA-I, logs, cidades) do localStorage. */
            function clearData() {
                bpaData = [];
                validationLog = [];
                editingIndex = -1;
                localStorage.removeItem('bpa_data');
                localStorage.removeItem('bpa_logs');
                localStorage.removeItem('editing_index');
                localStorage.removeItem('bpa_cities'); // Limpa também as cidades

                updateStatistics();
                displayData();
                document.getElementById('logArea').value = '';
                updateSubmitButton(false); // Reseta o botão para "Salvar Cadastro"
                addLog('🗑️ TODOS OS DADOS FORAM LIMPOS DO SISTEMA');
                showToast('Todos os dados foram removidos com sucesso!', 'success');
                
                closeConfigModal();
                populateAllPatientsForSearch();
            }

            // --- Funções de Modais ---

            /** Fecha todos os modais da aplicação. */
            function closeAllModals() {
                console.log('closeAllModals() chamado.');
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            /** Abre o modal de configurações administrativas. */
            function openConfigModal() {
                console.log('openConfigModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                document.getElementById('configModal').style.display = 'flex';
            }
            
            /** Fecha o modal de configurações administrativas. */
            function closeConfigModal() {
                console.log('closeConfigModal() chamado.');
                document.getElementById('configModal').style.display = 'none';
            }
            
            /** Abre o modal de gerenciamento de cidades. */
            function openCitiesModal() {
                console.log('openCitiesModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                document.getElementById('citiesModal').style.display = 'flex';
                displayCities(); // Atualiza a tabela de cidades ao abrir
                clearCityForm(); // Garante que o formulário de cidade esteja limpo e no modo de adição
            }
            
            /** Fecha o modal de gerenciamento de cidades. */
            function closeCitiesModal() {
                console.log('closeCitiesModal() chamado.');
                document.getElementById('citiesModal').style.display = 'none';
                // Não abre o configModal automaticamente aqui, o usuário deve clicar nele novamente
            }

            /** Abre o modal de seleção de relatórios. */
            function openReportModal() {
                console.log('openReportModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                document.getElementById('reportModal').style.display = 'flex';
                // Define o intervalo de datas padrão para hoje, se estiver vazio
                const today = new Date().toISOString().slice(0, 10);
                if (!document.getElementById('reportStartDate').value) {
                    document.getElementById('reportStartDate').value = today;
                }
                if (!document.getElementById('reportEndDate').value) {
                    document.getElementById('reportEndDate').value = today;
                }
            }
            
            /** Fecha o modal de seleção de relatórios. */
            function closeReportModal() {
                console.log('closeReportModal() chamado.');
                document.getElementById('reportModal').style.display = 'none';
            }
            
            /** Fecha o modal de visualização do relatório. */
            function closeReportViewModal() {
                console.log('closeReportViewModal() chamado.');
                document.getElementById('reportViewModal').style.display = 'none';
            }

            /**
             * Exibe o modal de confirmação de exclusão de um registro.
             * @param {number} index - O índice do registro a ser excluído.
             */
            function showDeleteConfirmModal(index) {
                console.log('showDeleteConfirmModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                recordToDeleteIndex = index;
                const record = bpaData[index];
                const recordName = escapeHtml(record.patientId || 'registro desconhecido');
                document.getElementById('recordToDeleteName').textContent = recordName;
                document.getElementById('deleteConfirmInput').value = '';
                document.getElementById('confirmDeleteBtn').disabled = true;
                document.getElementById('deleteConfirmModal').style.display = 'flex';

                // Adiciona listener para o input de confirmação
                document.getElementById('deleteConfirmInput').oninput = function() {
                    document.getElementById('confirmDeleteBtn').disabled = (this.value.toUpperCase() !== 'EXCLUIR');
                };

                // Adiciona listener para o botão de exclusão final
                document.getElementById('confirmDeleteBtn').onclick = performDeleteRecord;
            }

            /** Fecha o modal de confirmação de exclusão de registro. */
            function closeDeleteConfirmModal() {
                console.log('closeDeleteConfirmModal() chamado.');
                document.getElementById('deleteConfirmModal').style.display = 'none';
                recordToDeleteIndex = -1; // Reseta o índice
            }

            /** Realiza a exclusão do registro após a confirmação. */
            function performDeleteRecord() {
                if (recordToDeleteIndex === -1) return;

                const record = bpaData[recordToDeleteIndex];
                bpaData.splice(recordToDeleteIndex, 1);
                saveDataToStorage();
                updateStatistics();
                displayData();
                addLog(`Registro excluído: ${record.patientId}`);
                showToast(`Registro de ${record.patientId} excluído com sucesso!`, 'success');
                
                createBackup('EXCLUSAO'); // Cria backup após excluir
                populateAllPatientsForSearch(); // Re-popula a lista de pacientes
                closeDeleteConfirmModal();
            }

            /**
             * Exibe o modal de confirmação de exclusão de uma cidade.
             * @param {number} index - O índice da cidade a ser excluída.
             */
            function showCityDeleteConfirmModal(index) {
                console.log('showCityDeleteConfirmModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                cityToDeleteIndex = index;
                const city = customCities[index];
                document.getElementById('cityToDeleteName').textContent = escapeHtml(city.name);
                document.getElementById('cityDeleteConfirmInput').value = '';
                document.getElementById('confirmCityDeleteBtn').disabled = true;
                document.getElementById('cityDeleteConfirmModal').style.display = 'flex';

                document.getElementById('cityDeleteConfirmInput').oninput = function() {
                    document.getElementById('confirmCityDeleteBtn').disabled = (this.value.toUpperCase() !== 'REMOVER');
                };

                document.getElementById('confirmCityDeleteBtn').onclick = performCityDelete;
            }

            /** Fecha o modal de confirmação de exclusão de cidade. */
            function closeCityDeleteConfirmModal() {
                console.log('closeCityDeleteConfirmModal() chamado.');
                document.getElementById('cityDeleteConfirmModal').style.display = 'none';
                cityToDeleteIndex = -1;
            }

            /** Realiza a exclusão da cidade após a confirmação. */
            function performCityDelete() {
                if (cityToDeleteIndex === -1) return;

                const removedCity = customCities.splice(cityToDeleteIndex, 1)[0];
                saveCitiesToStorage();
                updateCitySelect();
                displayCities();
                addLog(`Cidade removida: ${removedCity.name}`);
                showToast(`Cidade "${removedCity.name}" removida com sucesso!`, 'success');
                closeCityDeleteConfirmModal();
            }

            /** Exibe o modal de confirmação para limpar todos os dados do sistema. */
            function showClearDataConfirmModal() {
                console.log('showClearDataConfirmModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                document.getElementById('clearDataConfirmInput').value = '';
                document.getElementById('confirmClearDataBtn').disabled = true;
                document.getElementById('clearDataConfirmModal').style.display = 'flex';

                document.getElementById('clearDataConfirmInput').oninput = function() {
                    document.getElementById('confirmClearDataBtn').disabled = (this.value.toUpperCase() !== 'APAGAR TUDO');
                };

                document.getElementById('confirmClearDataBtn').onclick = performClearData;
            }

            /** Fecha o modal de confirmação de limpeza de dados. */
            function closeClearDataConfirmModal() {
                console.log('closeClearDataConfirmModal() chamado.');
                document.getElementById('clearDataConfirmModal').style.display = 'none';
            }

            /** Realiza a limpeza de todos os dados do sistema após a confirmação. */
            function performClearData() {
                createBackup('LIMPEZA_TOTAL'); // Cria backup antes de limpar
                clearData();
                closeClearDataConfirmModal();
                showToast('Todos os dados foram removidos com sucesso!', 'success');
            }

            /**
             * Inicia o processo de seleção de arquivo para importação de dados CSV,
             * abrindo o modal de confirmação multi-etapas.
             */
            function selectFileToImport() {
                console.log('selectFileToImport() chamado.');
                const fileInput = document.getElementById('importDataFile');
                fileInput.value = ''; // Limpar seleção anterior
                
                fileInput.onchange = function() {
                    if (this.files && this.files[0]) {
                        importFileToProcess = this.files[0];
                        addLog(`Arquivo CSV selecionado para importação: ${importFileToProcess.name}`);
                        importCurrentStep = 1; // Inicia a primeira etapa do modal
                        showImportConfirmModal();
                    }
                };
                fileInput.click();
            }

            /** Exibe o modal de confirmação de importação CSV, progredindo por etapas. */
            function showImportConfirmModal() {
                console.log('showImportConfirmModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                const modal = document.getElementById('importConfirmModal');
                const modalTitle = document.getElementById('importModalTitle');
                const modalMessage = document.getElementById('importModalMessage');
                const confirmInput = document.getElementById('importConfirmInput');
                const nextBtn = document.getElementById('nextImportStepBtn');

                confirmInput.style.display = 'none';
                confirmInput.value = '';
                nextBtn.disabled = false;

                switch (importCurrentStep) {
                    case 1:
                        modalTitle.textContent = '📁 Confirmar Importação (Passo 1 de 3)';
                        modalMessage.innerHTML = `Você selecionou o arquivo: <strong>${escapeHtml(importFileToProcess.name)}</strong>.<br><br>Esta ação irá **ADICIONAR** novos dados ao sistema. Isso pode duplicar registros existentes ou misturar dados de diferentes fontes.`;
                        nextBtn.textContent = 'Continuar';
                        nextBtn.onclick = () => {
                            importCurrentStep = 2;
                            showImportConfirmModal();
                        };
                        break;
                    case 2:
                        modalTitle.textContent = '🚨 Confirmação Importação (Passo 2 de 3)';
                        modalMessage.innerHTML = `**CONFIRMAÇÃO FINAL:** Os dados importados serão **ADICIONADOS** aos existentes.<br><br>Recomenda-se fazer um backup antes da importação, pois esta ação não pode ser desfeita facilmente.`;
                        nextBtn.textContent = 'Continuar';
                        nextBtn.onclick = () => {
                            importCurrentStep = 3;
                            showImportConfirmModal();
                        };
                        break;
                    case 3:
                        modalTitle.textContent = '⚠️ Última Confirmação (Passo 3 de 3)';
                        modalMessage.innerHTML = `Para prosseguir com a importação, digite exatamente: <strong style="color: #e74c3c;">IMPORTAR DADOS</strong> no campo abaixo.`;
                        confirmInput.style.display = 'block';
                        nextBtn.textContent = 'Importar Agora';
                        nextBtn.disabled = true;

                        confirmInput.oninput = function() {
                            nextBtn.disabled = (this.value.toUpperCase() !== 'IMPORTAR DADOS');
                        };
                        nextBtn.onclick = performImportData;
                        break;
                }
                modal.style.display = 'flex';
            }

            /** Fecha o modal de confirmação de importação CSV e reseta o estado. */
            function closeImportConfirmModal() {
                console.log('closeImportConfirmModal() chamado.');
                document.getElementById('importConfirmModal').style.display = 'none';
                if (importFileToProcess) { // Só mostra o toast se um arquivo estava sendo processado
                    addLog('Importação CSV cancelada pelo usuário.');
                    showToast('Importação CSV cancelada.', 'info');
                }
                importFileToProcess = null;
                importCurrentStep = 0;
                document.getElementById('importDataFile').value = ''; // Limpa o input file
            }

            /** Realiza a importação dos dados do arquivo CSV selecionado. */
            function performImportData() {
                if (!importFileToProcess) {
                    showToast('Nenhum arquivo para importar.', 'error');
                    addLog('ERRO: Nenhum arquivo para importar no performImportData.');
                    closeImportConfirmModal();
                    return;
                }
                
                addLog(`=== INICIANDO IMPORTAÇÃO CSV ===`);
                addLog(`Arquivo: ${importFileToProcess.name} (${(importFileToProcess.size/1024).toFixed(2)} KB)`);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim());
                        
                        addLog(`Linhas no arquivo: ${lines.length}`);
                        
                        if (lines.length === 0) {
                            showToast('Arquivo vazio.', 'warning');
                            closeImportConfirmModal();
                            return;
                        }
                        
                        // Detectar cabeçalho
                        const firstLine = lines[0].toLowerCase();
                        const hasHeader = firstLine.includes('data_cadastro') || firstLine.includes('nome_paciente');
                        const startIndex = hasHeader ? 1 : 0;
                        
                        addLog(`Cabeçalho: ${hasHeader ? 'Detectado' : 'Não detectado'}`);
                        addLog(`Processando ${lines.length - startIndex} linhas de dados...`);
                        
                        let importedCount = 0;
                        let errorCount = 0;
                        
                        // Processar cada linha
                        for (let i = startIndex; i < lines.length; i++) {
                            const columns = lines[i].split(';');
                            
                            if (columns.length >= 32) { // Verificar número mínimo de colunas esperadas
                                try {
                                    const record = {
                                        id: columns[31]?.replace(/"/g, '').trim() || generateUniqueId(),
                                        filename: columns[29]?.replace(/"/g, '').trim() || 'imported_data',
                                        lineNumber: parseInt(columns[30]?.replace(/"/g, '').trim()) || (i + 1),
                                        originalLine: 'IMPORTED',
                                        dtCadastro: columns[0]?.replace(/"/g, '').trim() || new Date().toLocaleString('pt-BR'),
                                        patientId: columns[1]?.replace(/"/g, '').trim() || '',
                                        cnsPaciente: columns[2]?.replace(/"/g, '').replace(/[^\d]/g, '') || '',
                                        sexo: columns[3]?.toLowerCase().includes('masculino') ? '1' : (columns[3]?.toLowerCase().includes('feminino') ? '2' : ''),
                                        dtNascimento: convertDateToInternal(columns[4]?.replace(/"/g, '').trim()) || '',
                                        nacionalidade: columns[5]?.includes('Brasileira') ? '010' : (columns[5]?.includes('Naturalizado') ? '020' : (columns[5]?.includes('Estrangeiro') ? '030' : '')),
                                        raca: getRacaCodeFromText(columns[6]?.replace(/"/g, '').trim()) || '',
                                        etnia: columns[7]?.replace(/"/g, '').trim() || '',
                                        codLogradouro: columns[9]?.replace(/"/g, '').trim() || '',
                                        endereco: columns[10]?.replace(/"/g, '').trim() || '',
                                        numero: columns[11]?.replace(/"/g, '').trim() || 's/n',
                                        bairro: columns[12]?.replace(/"/g, '').trim() || '',
                                        complemento: columns[13]?.replace(/"/g, '').trim() || '',
                                        telefone: columns[14]?.replace(/[^\d]/g, '') || '',
                                        dtAtendimento: convertDateToInternal(columns[15]?.replace(/"/g, '').trim()) || '',
                                        local: columns[16]?.replace(/"/g, '').trim() || '',
                                        cidade: columns[17]?.replace(/"/g, '').trim() || '',
                                        distanciaKm: parseInt(columns[18]?.replace(/"/g, '').trim()) || 0,
                                        totalProcedimentos: parseInt(columns[19]?.replace(/"/g, '').trim()) || 0,
                                        horario: columns[20]?.replace(/"/g, '').trim() || '',
                                        tipoAtendimento: getTipoAtendimentoFromText(columns[21]?.replace(/"/g, '').trim()) || '',
                                        tipoAtendimentoCodigo: columns[22]?.replace(/"/g, '').trim() || '',
                                        transporte: getTransporteFromText(columns[23]?.replace(/"/g, '').trim()) || '',
                                        motorista: columns[24]?.replace(/"/g, '').trim() || '',
                                        horaSaida: columns[25]?.replace(/"/g, '').trim() || '',
                                        observacao: columns[26]?.replace(/"/g, '').trim() || '',
                                        parentPatientId: columns[27]?.replace(/"/g, '').trim() || '',
                                        status: columns[28]?.replace(/"/g, '').trim() || 'pending',
                                        errors: [], // Erros serão re-validados após a importação
                                        tipoDado: '03',
                                        municipio: '999999',
                                        cnes: '0000000',
                                        cbo: '000000',
                                        caraAtendimento: '01',
                                        origem: '1'
                                    };
                                    
                                    bpaData.push(record);
                                    importedCount++;
                                    
                                } catch (error) {
                                    errorCount++;
                                    addLog(`Erro na linha ${i + 1} durante a importação: ${error.message}`);
                                }
                            } else {
                                errorCount++;
                                addLog(`Linha ${i + 1} ignorada: número de colunas insuficiente (${columns.length} < 32).`);
                            }
                        }
                        
                        saveDataToStorage();
                        updateStatistics();
                        displayData();
                        
                        if (importedCount > 0) {
                            createBackup('IMPORTACAO');
                        }
                        
                        const totalAfter = bpaData.length;
                        
                        addLog(`=== RESULTADO DA IMPORTAÇÃO CSV ===`);
                        addLog(`Registros importados: ${importedCount}`);
                        addLog(`Registros com erro na leitura: ${errorCount}`);
                        addLog(`Total de registros no sistema: ${totalAfter}`);
                        
                        showToast(`Importação concluída: ${importedCount} registros adicionados.`, 'success');
                        
                        closeImportConfirmModal();
                        closeConfigModal();
                        populateAllPatientsForSearch();
                        
                    } catch (error) {
                        showToast(`Erro ao processar arquivo: ${error.message}`, 'error');
                        addLog(`ERRO CRÍTICO na importação CSV: ${error.message}`);
                        closeImportConfirmModal();
                    }
                };
                
                reader.readAsText(importFileToProcess, 'UTF-8');
            }

            /**
             * Inicia o processo de seleção de arquivo para importação de backup JSON,
             * abrindo o modal de confirmação multi-etapas.
             */
            function selectJsonFileToImport() {
                console.log('selectJsonFileToImport() chamado.');
                const fileInput = document.getElementById('importJsonFile');
                fileInput.value = ''; // Limpar seleção anterior
                
                fileInput.onchange = function() {
                    if (this.files && this.files[0]) {
                        jsonFileToProcess = this.files[0];
                        addLog(`Arquivo JSON selecionado para importação: ${jsonFileToProcess.name}`);
                        jsonImportCurrentStep = 1; // Inicia a primeira etapa do modal JSON
                        showJsonImportConfirmModal();
                    }
                };
                fileInput.click();
            }

            /**
             * Exibe o modal de confirmação de importação JSON, progredindo por etapas.
             */
            function showJsonImportConfirmModal() {
                console.log('showJsonImportConfirmModal() chamado.');
                closeAllModals(); // Garante que outros modais estejam fechados
                const modal = document.getElementById('jsonImportConfirmModal');
                const modalTitle = document.getElementById('jsonImportModalTitle');
                const modalMessage = document.getElementById('jsonImportModalMessage');
                const confirmInput = document.getElementById('jsonImportConfirmInput');
                const nextBtn = document.getElementById('nextJsonImportStepBtn');

                confirmInput.style.display = 'none';
                confirmInput.value = '';
                nextBtn.disabled = false;

                switch (jsonImportCurrentStep) {
                    case 1:
                        modalTitle.textContent = '📦 Confirmar Restauração (Passo 1 de 3)';
                        modalMessage.innerHTML = `Você selecionou o arquivo de backup: <strong>${escapeHtml(jsonFileToProcess.name)}</strong>.<br><br>Esta ação irá **SUBSTITUIR TODOS OS DADOS ATUAIS** do sistema (registros, cidades e logs) pelos dados do backup.`;
                        nextBtn.textContent = 'Continuar';
                        nextBtn.onclick = () => {
                            jsonImportCurrentStep = 2;
                            showJsonImportConfirmModal();
                        };
                        break;
                    case 2:
                        modalTitle.textContent = '🚨 Confirmação Restauração (Passo 2 de 3)';
                        modalMessage.innerHTML = `**CONFIRMAÇÃO FINAL:** Todos os dados atuais serão **APAGADOS E SUBSTITUÍDOS** pelo conteúdo do backup JSON.<br><br>Esta ação é **IRREVERSÍVEL**. Certifique-se de que este é o backup correto.`;
                        nextBtn.textContent = 'Continuar';
                        nextBtn.onclick = () => {
                            jsonImportCurrentStep = 3;
                            showJsonImportConfirmModal();
                        };
                        break;
                    case 3:
                        modalTitle.textContent = '⚠️ Última Confirmação (Passo 3 de 3)';
                        modalMessage.innerHTML = `Para prosseguir com a restauração, digite exatamente: <strong style="color: #e74c3c;">RESTAURAR BACKUP</strong> no campo abaixo.`;
                        confirmInput.style.display = 'block';
                        nextBtn.textContent = 'Restaurar Agora';
                        nextBtn.disabled = true;

                        confirmInput.oninput = function() {
                            nextBtn.disabled = (this.value.toUpperCase() !== 'RESTAURAR BACKUP');
                        };
                        nextBtn.onclick = performJsonImport;
                        break;
                }
                modal.style.display = 'flex';
            }

            /**
             * Fecha o modal de confirmação de importação JSON e reseta o estado.
             */
            function closeJsonImportConfirmModal() {
                console.log('closeJsonImportConfirmModal() chamado.');
                document.getElementById('jsonImportConfirmModal').style.display = 'none';
                // Apenas mostra o toast de cancelamento se o arquivo ainda estiver definido,
                // o que significa que o modal foi fechado sem concluir a importação.
                if (jsonFileToProcess) { 
                    addLog('Restauração de backup JSON cancelada pelo usuário.');
                    showToast('Restauração de backup JSON cancelada.', 'info');
                }
                jsonFileToProcess = null; // Garante que seja limpo após o uso
                jsonImportCurrentStep = 0;
                document.getElementById('importJsonFile').value = ''; // Limpa o input file
            }

            /**
             * Realiza a importação dos dados do arquivo JSON selecionado,
             * substituindo os dados atuais da aplicação.
             */
            function performJsonImport() {
                if (!jsonFileToProcess) {
                    showToast('Nenhum arquivo JSON para importar.', 'error');
                    addLog('ERRO: Nenhum arquivo JSON para importar no performJsonImport.');
                    closeJsonImportConfirmModal();
                    return;
                }

                addLog(`=== INICIANDO RESTAURAÇÃO DE BACKUP JSON ===`);
                addLog(`Arquivo: ${jsonFileToProcess.name} (${(jsonFileToProcess.size/1024).toFixed(2)} KB)`);

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const backupData = JSON.parse(content);

                        if (backupData && backupData.bpaData && Array.isArray(backupData.bpaData)) {
                            // Substitui os dados existentes pelos dados do backup
                            bpaData = backupData.bpaData.map(record => ({
                                ...record,
                                errors: Array.isArray(record.errors) ? record.errors : []
                            }));
                            customCities = Array.isArray(backupData.customCities) ? backupData.customCities : [];
                            validationLog = Array.isArray(backupData.validationLog) ? backupData.validationLog : [];

                            saveDataToStorage();
                            saveCitiesToStorage();
                            updateStatistics();
                            displayData();
                            document.getElementById('logArea').value = validationLog.join('\n');
                            populateAllPatientsForSearch();

                            addLog(`Backup JSON restaurado com sucesso! Registros: ${bpaData.length}, Cidades: ${customCities.length}`);
                            showToast('Backup JSON restaurado com sucesso!', 'success');
                            
                            // Limpa jsonFileToProcess AQUI para evitar o toast de "cancelada" ao fechar o modal
                            jsonFileToProcess = null; 

                            closeJsonImportConfirmModal();
                            closeConfigModal();

                        } else {
                            showToast('Formato de arquivo JSON de backup inválido.', 'error');
                            addLog('ERRO: Formato de arquivo JSON de backup inválido.');
                            closeJsonImportConfirmModal();
                        }
                    } catch (error) {
                        showToast(`Erro ao processar arquivo JSON: ${error.message}`, 'error');
                        addLog(`ERRO CRÍTICO na restauração JSON: ${error.message}`);
                        closeJsonImportConfirmModal();
                    }
                };
                reader.readAsText(jsonFileToProcess, 'UTF-8');
            }
            
            /**
             * Valida os campos do formulário antes de adicionar/atualizar um registro.
             * @returns {boolean} True se todos os campos obrigatórios e válidos forem preenchidos, false caso contrário.
             */
            function validateFormFields() {
                const cnsPacienteRaw = document.getElementById('patientCNS').value.trim();
                const patientName = document.getElementById('patientName').value.trim();
                const gender = document.getElementById('gender').value;
                const birthDate = document.getElementById('birthDate').value;
                const nacionalidade = document.getElementById('nacionalidade').value;
                const raca = document.getElementById('raca').value;
                const etnia = document.getElementById('etnia').value.trim();
                const codLogradouro = document.getElementById('codLogradouro').value.trim();
                const endereco = document.getElementById('endereco').value.trim();
                const numero = document.getElementById('numero').value.trim();
                const complemento = document.getElementById('complemento').value.trim();
                const bairroRural = document.getElementById('bairro').value.trim();
                const bairroUrbano = document.getElementById('bairroUrbano').value.trim();
                const telefone = document.getElementById('telefone').value.trim();
                const serviceDate = document.getElementById('serviceDate').value;
                const local = document.getElementById('local').value.trim();
                const cidade = document.getElementById('cidade').value;
                const horario = document.getElementById('horario').value;
                const tipoAtendimento = document.getElementById('tipoAtendimento').value;
                const parentPatientId = document.getElementById('parentPatientId').value;
                const transporteBtn = document.querySelector('.transport-btn.selected');
                const transporte = transporteBtn ? transporteBtn.dataset.value : '';

                // Validações de Identificação do Paciente
                if (!cnsPacienteRaw) { showToast('Por favor, preencha o CNS/CPF do paciente.', 'error'); return false; }
                if (!patientName) { showToast('Por favor, preencha o nome do paciente.', 'error'); return false; }
                if (!gender) { showToast('Por favor, selecione o sexo.', 'error'); return false; }
                if (!birthDate) { showToast('Por favor, preencha a data de nascimento.', 'error'); return false; }
                if (!nacionalidade) { showToast('Por favor, selecione a nacionalidade.', 'error'); return false; }
                if (!raca) { showToast('Por favor, selecione a raça/cor.', 'error'); return false; }
                if (raca === '05' && !etnia) { showToast('Por favor, preencha a etnia (obrigatório para raça Indígena).', 'error'); return false; }
                if (!codLogradouro) { showToast('Por favor, selecione o logradouro.', 'error'); return false; }

                // Validações condicionais baseadas no logradouro
                if (codLogradouro === '081') { // Área Urbana
                    if (!endereco) { showToast('Por favor, preencha o endereço.', 'error'); return false; }
                    if (!numero && document.getElementById('numero').value.trim() === '') { showToast('Por favor, preencha o número ou deixe em branco para "s/n".', 'error'); return false; }
                    if (!bairroUrbano) { showToast('Por favor, preencha o bairro.', 'error'); return false; }
                } else if (codLogradouro === '024') { // Zona Rural
                    if (!bairroRural) { showToast('Por favor, preencha o córrego.', 'error'); return false; }
                }
                if (!telefone) { showToast('Por favor, preencha o telefone.', 'error'); return false; }

                // Validações de Procedimento Realizado
                if (!serviceDate) { showToast('Por favor, preencha a data do atendimento.', 'error'); return false; }
                if (!local) { showToast('Por favor, preencha o local de atendimento.', 'error'); return false; }
                if (!cidade) { showToast('Por favor, selecione a cidade.', 'error'); return false; }
                if (!horario) { showToast('Por favor, preencha o horário.', 'error'); return false; }
                if (!tipoAtendimento) { showToast('Por favor, selecione o tipo de atendimento.', 'error'); return false; }
                if (!transporte) { showToast('Por favor, selecione uma opção de transporte.', 'error'); return false; }
                
                // Validação de Paciente Principal para acompanhantes
                if (tipoAtendimento === 'acompanhante' && !parentPatientId) {
                    showToast('Por favor, selecione o Paciente Principal para o acompanhante.', 'error');
                    return false;
                }
                
                // Validação de CNS ou CPF
                if (!isValidCNSOrCPF(cnsPacienteRaw)) {
                    showToast('CNS ou CPF inválido. Verifique o número digitado.', 'error');
                    return false;
                }
                return true;
            }

            /**
             * Coleta os dados do formulário e retorna um objeto de registro.
             * @returns {object} O objeto de registro BPA-I.
             */
            function getFormData() {
                const cnsPacienteRaw = document.getElementById('patientCNS').value.trim();
                const patientName = document.getElementById('patientName').value.trim();
                const gender = document.getElementById('gender').value;
                const birthDate = document.getElementById('birthDate').value;
                const nacionalidade = document.getElementById('nacionalidade').value;
                const raca = document.getElementById('raca').value;
                const etnia = document.getElementById('etnia').value.trim();
                const codLogradouro = document.getElementById('codLogradouro').value.trim();
                const endereco = document.getElementById('endereco').value.trim();
                let numero = document.getElementById('numero').value.trim();
                const complemento = document.getElementById('complemento').value.trim();
                const bairro = document.getElementById('bairro').value.trim() || document.getElementById('bairroUrbano').value.trim();
                const telefone = document.getElementById('telefone').value.trim();
                const serviceDate = document.getElementById('serviceDate').value;
                const local = document.getElementById('local').value.trim();
                const cidade = document.getElementById('cidade').value;
                const horario = document.getElementById('horario').value;
                const tipoAtendimento = document.getElementById('tipoAtendimento').value;
                const parentPatientId = document.getElementById('parentPatientId').value;
                const transporteBtn = document.querySelector('.transport-btn.selected');
                const transporte = transporteBtn ? transporteBtn.dataset.value : '';
                const motorista = document.getElementById('motorista').value.trim();
                let observacao = document.getElementById('observacao').value.trim();
                const horaSaida = document.getElementById('horaSaida').value.trim();

                if (numero === '') {
                    numero = 's/n';
                }

                if (tipoAtendimento === 'acompanhante' && observacao === '') {
                    const parentPatientRecord = bpaData.find(rec => rec.id === parentPatientId);
                    if (parentPatientRecord) {
                        observacao = `Acompanhante de ${parentPatientRecord.patientId}`;
                    } else {
                        observacao = 'Acompanhante (Paciente Principal não encontrado)';
                    }
                }

                const cnsPacienteClean = cnsPacienteRaw.replace(/\D/g, '');
                const dtNascimento = birthDate.split('-').reverse().join('');
                const dtAtendimento = serviceDate.split('-').reverse().join('');
                const cityData = getCityData(cidade);

                return {
                    id: generateUniqueId(),
                    filename: 'manual_entry',
                    lineNumber: bpaData.length + 1,
                    originalLine: 'MANUAL',
                    patientId: patientName.toUpperCase(),
                    tipoDado: '03',
                    cnsPaciente: cnsPacienteClean.length === 11 ? cnsPacienteClean.padStart(15, '0') : cnsPacienteClean,
                    dtNascimento: dtNascimento,
                    sexo: gender,
                    nacionalidade: nacionalidade || '010',
                    raca: raca || '99',
                    etnia: etnia,
                    codLogradouro: codLogradouro,
                    endereco: endereco.toUpperCase(),
                    numero: numero,
                    complemento: complemento.toUpperCase(),
                    bairro: bairro.toUpperCase(),
                    telefone: telefone.replace(/\D/g, ''),
                    dtCadastro: new Date().toLocaleString('pt-BR'),
                    cnes: '0000000', // Valor padrão, pode ser ajustado se houver campo
                    cbo: '000000', // Valor padrão, pode ser ajustado se houver campo
                    dtAtendimento: dtAtendimento,
                    tipoAtendimentoCodigo: getTipoAtendimentoCodigo(tipoAtendimento),
                    local: local.toUpperCase(),
                    cidade: cidade,
                    distanciaKm: cityData.km,
                    totalProcedimentos: cityData.procedures,
                    horario: horario,
                    tipoAtendimento: tipoAtendimento,
                    transporte: transporte,
                    motorista: motorista,
                    horaSaida: horaSaida,
                    observacao: observacao,
                    caraAtendimento: '01', // Valor padrão, pode ser ajustado se houver campo
                    origem: '1', // Valor padrão, pode ser ajustado se houver campo
                    status: 'valid', // Assume válido na entrada manual, validação posterior pode alterar
                    errors: [],
                    parentPatientId: tipoAtendimento === 'acompanhante' ? parentPatientId : '',
                };
            }

            /** Adiciona um novo registro BPA-I manualmente após validação do formulário. */
            function addManualRecord() {
                if (!validateFormFields()) {
                    return; // Interrompe se a validação falhar
                }
                
                const record = getFormData();
                bpaData.push(record);
                saveDataToStorage();
                updateStatistics();
                displayData();
                addLog(`Registro adicionado: ${record.patientId}`);
                showToast(`Registro de ${record.patientId} adicionado com sucesso!`, 'success');
                
                createBackup('NOVO_CADASTRO');
                clearForm();
                populateAllPatientsForSearch();
            }

            /** Atualiza um registro BPA-I existente após validação do formulário. */
            function updateRecord() {
                if (editingIndex === -1) return;
                if (!validateFormFields()) {
                    return; // Interrompe se a validação falhar
                }
                
                const updatedData = getFormData();
                // Preserva o ID original e outros campos que não são alterados pelo formulário
                bpaData[editingIndex] = {
                    ...bpaData[editingIndex],
                    ...updatedData,
                    id: bpaData[editingIndex].id, // Garante que o ID não mude
                    dtCadastro: bpaData[editingIndex].dtCadastro // Garante que a data de cadastro não mude
                };
                
                editingIndex = -1; // Reseta o índice de edição
                localStorage.setItem('editing_index', '-1');
                
                updateSubmitButton(false); // Reseta o botão para modo de cadastro
                
                saveDataToStorage();
                updateStatistics();
                displayData();
                clearForm();
                addLog(`Registro atualizado: ${updatedData.patientId}`);
                showToast(`Registro de ${updatedData.patientId} atualizado com sucesso!`, 'success');
                
                createBackup('EDICAO_SALVA');
                populateAllPatientsForSearch();
            }

            /** Limpa todos os campos do formulário de cadastro manual. */
            function clearForm() {
                document.getElementById('manualForm').reset();
                // Limpar seleção de transporte
                document.querySelectorAll('.transport-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Resetar campo de paciente principal
                document.getElementById('parentPatientGroup').style.display = 'none';
                document.getElementById('parentPatientSearch').value = '';
                document.getElementById('parentPatientId').value = '';
                document.getElementById('parentPatientSearchResults').innerHTML = '';

                // Ocultar e limpar campos de Motorista e Hora de Saída
                document.getElementById('transportSpecificFields').style.display = 'none';
                document.getElementById('motorista').value = '';
                document.getElementById('horaSaida').value = '';

                // Resetar botão para modo de cadastro
                updateSubmitButton(false);

                // Limpar indicadores de CNS/CPF
                document.getElementById('cnsTypeIndicator').textContent = '';
                document.getElementById('patientCNS').style.borderColor = '#ecf0f1';

                // Reaplicar estados iniciais dos campos condicionais
                handleLogradouroChange({ target: { value: '' } }); // Reseta logradouro para "Selecione"
                handleRacaChange({ target: { value: '' } }); // Reseta raça para "Selecione"
                updateTipoAtendimentoOptions(); // Revalida opções de tipo de atendimento

                showToast('Formulário limpo.', 'info');
            }
            
            /**
             * Atualiza o texto e a ação do botão de salvar no formulário.
             * @param {boolean} isEditing - True se estiver no modo de edição, false para cadastro.
             */
            function updateSubmitButton(isEditing) {
                const submitBtn = document.getElementById('submitBtn');
                if (isEditing) {
                    submitBtn.textContent = '✅ Salvar Alterações';
                    submitBtn.onclick = updateRecord;
                } else {
                    submitBtn.textContent = '✅ Salvar Cadastro';
                    submitBtn.onclick = addManualRecord;
                }
            }

            /**
             * Inicia o processo de edição de um registro existente, preenchendo o formulário.
             * @param {number} index - O índice do registro a ser editado.
             */
            function editRecord(index) {
                const record = bpaData[index];
                editingIndex = index;
                
                // Preencher formulário com dados do registro
                document.getElementById('patientCNS').value = formatCNSForDisplay(record.cnsPaciente);
                document.getElementById('patientName').value = record.patientId || '';
                document.getElementById('gender').value = record.sexo || '';
                document.getElementById('birthDate').value = formatDateForInput(record.dtNascimento);
                document.getElementById('nacionalidade').value = record.nacionalidade || '010';
                document.getElementById('raca').value = record.raca || '03';
                document.getElementById('etnia').value = record.etnia || '';
                document.getElementById('codLogradouro').value = record.codLogradouro || '';
                document.getElementById('endereco').value = record.endereco || '';
                document.getElementById('numero').value = record.numero || '';
                document.getElementById('complemento').value = record.complemento || '';
                
                if (record.codLogradouro === '024') {
                    document.getElementById('bairro').value = record.bairro || '';
                    document.getElementById('bairroUrbano').value = ''; // Garante que o outro campo esteja vazio
                } else {
                    document.getElementById('bairroUrbano').value = record.bairro || '';
                    document.getElementById('bairro').value = ''; // Garante que o outro campo esteja vazio
                }
                
                document.getElementById('telefone').value = formatTelefoneForDisplay(record.telefone) || '';
                document.getElementById('serviceDate').value = formatDateForInput(record.dtAtendimento);
                document.getElementById('local').value = record.local || '';
                document.getElementById('cidade').value = record.cidade || '';
                document.getElementById('horario').value = record.horario || '';
                document.getElementById('tipoAtendimento').value = record.tipoAtendimento || '';
                document.getElementById('observacao').value = record.observacao || '';
                
                // Selecionar transporte
                document.querySelectorAll('.transport-btn').forEach(btn => btn.classList.remove('selected'));
                if (record.transporte) {
                    const transportBtn = document.querySelector(`[data-value="${record.transporte}"]`);
                    if (transportBtn) {
                        transportBtn.classList.add('selected');
                        document.getElementById('transportSpecificFields').style.display = 'block';
                    }
                } else {
                    document.getElementById('transportSpecificFields').style.display = 'none';
                }
                
                document.getElementById('motorista').value = record.motorista || '';
                document.getElementById('horaSaida').value = record.horaSaida || '';

                // Preencher campo de paciente principal para acompanhantes
                if (record.tipoAtendimento === 'acompanhante' && record.parentPatientId) {
                    const parentPatientRecord = bpaData.find(p => p.id === record.parentPatientId);
                    if (parentPatientRecord) {
                        document.getElementById('parentPatientSearch').value = `${parentPatientRecord.patientId} (${formatCNSForDisplay(parentPatientRecord.cnsPaciente)})`;
                        document.getElementById('parentPatientId').value = parentPatientRecord.id;
                    }
                } else {
                    document.getElementById('parentPatientSearch').value = '';
                    document.getElementById('parentPatientId').value = '';
                }

                // Acionar eventos de mudança para atualizar a UI (etnia, logradouro, tipoAtendimento)
                handleLogradouroChange({ target: { value: record.codLogradouro } });
                handleRacaChange({ target: { value: record.raca } });
                handleTipoAtendimentoChange({ target: { value: record.tipoAtendimento } });
                validateCNSField({ target: document.getElementById('patientCNS') }); // Revalida CNS/CPF para feedback visual

                updateSubmitButton(true); // Altera botão para modo de edição
                
                document.getElementById('manualForm').scrollIntoView({ behavior: 'smooth' });
                
                addLog(`Editando registro: ${record.patientId}`);
                showToast(`Editando registro de ${record.patientId}.`, 'info');
            }
            
            /**
             * Baixa um arquivo com o conteúdo e nome especificados.
             * @param {string} filename - O nome do arquivo a ser baixado.
             * @param {string} content - O conteúdo do arquivo.
             */
            function downloadFile(filename, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            /**
             * Adiciona uma mensagem ao log de validação e a exibe na área de log.
             * @param {string} message - A mensagem a ser adicionada ao log.
             */
            function addLog(message) {
                const timestamp = new Date().toLocaleString('pt-BR');
                const logEntry = `[${timestamp}] ${message}`;
                validationLog.push(logEntry);
                
                const logArea = document.getElementById('logArea');
                logArea.value = validationLog.join('\n');
                logArea.scrollTop = logArea.scrollHeight; // Rola para o final do log
                
                saveDataToStorage(); // Salva o log no localStorage
            }

            /**
             * Lida com a seleção de um botão de transporte, aplicando o estilo 'selected'
             * e mostrando/ocultando campos específicos do transporte.
             * @param {HTMLElement} button - O botão de transporte clicado.
             */
            function selectTransport(button) {
                // Remove seleção de todos os botões
                document.querySelectorAll('.transport-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Adiciona seleção ao botão clicado
                button.classList.add('selected');

                // Mostrar campos de Motorista e Hora de Saída
                document.getElementById('transportSpecificFields').style.display = 'block';
            }
            
            /** Popula a lista `allPatientsForSearch` com registros de 'paciente' válidos para a funcionalidade de busca. */
            function populateAllPatientsForSearch() {
                allPatientsForSearch = bpaData.filter(rec => rec.tipoAtendimento === 'paciente' && rec.status === 'valid');
                allPatientsForSearch.sort((a, b) => (a.patientId || '').localeCompare(b.patientId || ''));
            }

            /**
             * Filtra e exibe sugestões de pacientes para o campo de Paciente Principal.
             * @param {Event} event - O evento de input.
             */
            function filterParentPatients(event) {
                const searchTerm = event.target.value.toLowerCase();
                const searchResultsDiv = document.getElementById('parentPatientSearchResults');
                searchResultsDiv.innerHTML = '';

                const currentRecordId = editingIndex !== -1 ? bpaData[editingIndex].id : null;

                if (searchTerm.length < 2) {
                    searchResultsDiv.style.display = 'none';
                    return;
                }

                const filteredPatients = allPatientsForSearch.filter(patient => {
                    // Impede que o próprio registro em edição apareça como paciente principal
                    if (currentRecordId && currentRecordId === patient.id) {
                        return false;
                    }
                    const patientNameMatch = patient.patientId && patient.patientId.toLowerCase().startsWith(searchTerm);
                    const cnsCpfMatch = patient.cnsPaciente && patient.cnsPaciente.toLowerCase().replace(/\D/g, '').startsWith(searchTerm.replace(/\D/g, ''));
                    
                    return patientNameMatch || cnsCpfMatch;
                });

                if (filteredPatients.length > 0) {
                    filteredPatients.slice(0, 10).forEach(patient => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-results-item');
                        resultItem.textContent = `${escapeHtml(patient.patientId)} (${escapeHtml(formatCNSForDisplay(patient.cnsPaciente))})`;
                        resultItem.onclick = () => selectParentPatient(patient.id, patient.patientId, patient.cnsPaciente);
                        searchResultsDiv.appendChild(resultItem);
                    });
                    searchResultsDiv.style.display = 'block';
                } else {
                    const noResultsItem = document.createElement('div');
                    noResultsItem.classList.add('search-results-item');
                    noResultsItem.textContent = 'Nenhum paciente encontrado.';
                    noResultsItem.style.fontStyle = 'italic';
                    noResultsItem.style.color = '#777';
                    searchResultsDiv.appendChild(noResultsItem);
                    searchResultsDiv.style.display = 'block';
                }
            }

            /**
             * Seleciona um paciente principal da lista de pesquisa e preenche os campos relacionados.
             * @param {string} patientId - O ID do paciente selecionado.
             * @param {string} patientName - O nome do paciente selecionado.
             * @param {string} patientCNS - O CNS do paciente selecionado.
             */
            function selectParentPatient(patientId, patientName, patientCNS) {
                document.getElementById('parentPatientId').value = patientId;
                document.getElementById('parentPatientSearch').value = `${patientName} (${formatCNSForDisplay(patientCNS)})`;
                document.getElementById('parentPatientSearchResults').style.display = 'none';
            }

            /**
             * Retorna o nome formatado de um paciente dado seu ID.
             * @param {string} patientId - O ID do paciente.
             * @returns {string} O nome formatado do paciente (Nome (CNS/CPF)) ou string vazia se não encontrado.
             */
            function getPatientNameById(patientId) {
                const patientRecord = bpaData.find(record => record.id === patientId);
                return patientRecord ? `${patientRecord.patientId} (${formatCNSForDisplay(patientRecord.cnsPaciente)})` : '';
            }
            
            /**
             * Filtra e exibe sugestões de pacientes para os campos CNS/CPF e Nome.
             * @param {string} searchTerm - O termo de pesquisa.
             * @param {string} fieldType - O tipo de campo ('cns' ou 'name').
             */
            function filterPatientSuggestions(searchTerm, fieldType) {
                const searchResultsDiv = fieldType === 'cns' ? document.getElementById('cnsSearchResults') : document.getElementById('nameSearchResults');
                searchResultsDiv.innerHTML = '';
                
                const cleanSearchTerm = searchTerm.toLowerCase().replace(/\D/g, '');
                const lowerSearchTerm = searchTerm.toLowerCase();

                if (searchTerm.length < 2) {
                    searchResultsDiv.style.display = 'none';
                    return;
                }

                const filteredPatients = allPatientsForSearch.filter(patient => {
                    if (fieldType === 'cns') {
                        return (patient.cnsPaciente && patient.cnsPaciente.toLowerCase().replace(/\D/g, '').startsWith(cleanSearchTerm));
                    } else { // fieldType === 'name'
                        return (patient.patientId && patient.patientId.toLowerCase().startsWith(lowerSearchTerm));
                    }
                });

                if (filteredPatients.length > 0) {
                    filteredPatients.slice(0, 10).forEach(patient => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-results-item');
                        resultItem.textContent = `${escapeHtml(patient.patientId)} (${escapeHtml(formatCNSForDisplay(patient.cnsPaciente))})`;
                        resultItem.onclick = () => selectExistingPatient(patient.id);
                        searchResultsDiv.appendChild(resultItem);
                    });
                    searchResultsDiv.style.display = 'block';
                } else {
                    searchResultsDiv.style.display = 'none';
                }
            }

            /**
             * Preenche o formulário com os dados de um paciente existente selecionado da busca.
             * @param {string} patientId - O ID do paciente a ser selecionado.
             */
            function selectExistingPatient(patientId) {
                const patientRecord = bpaData.find(record => record.id === patientId);
                if (patientRecord) {
                    document.getElementById('patientCNS').value = formatCNSForDisplay(patientRecord.cnsPaciente);
                    document.getElementById('patientName').value = patientRecord.patientId || '';
                    document.getElementById('gender').value = patientRecord.sexo || '';
                    document.getElementById('birthDate').value = formatDateForInput(patientRecord.dtNascimento);
                    document.getElementById('nacionalidade').value = patientRecord.nacionalidade || '010';
                    document.getElementById('raca').value = patientRecord.raca || '03';
                    document.getElementById('etnia').value = patientRecord.etnia || '';
                    document.getElementById('codLogradouro').value = patientRecord.codLogradouro || '';
                    document.getElementById('endereco').value = patientRecord.endereco || '';
                    document.getElementById('numero').value = patientRecord.numero || '';
                    document.getElementById('complemento').value = patientRecord.complemento || '';
                    
                    if (patientRecord.codLogradouro === '024') {
                        document.getElementById('bairro').value = patientRecord.bairro || '';
                        document.getElementById('bairroUrbano').value = '';
                    } else {
                        document.getElementById('bairroUrbano').value = patientRecord.bairro || '';
                        document.getElementById('bairro').value = '';
                    }
                    
                    document.getElementById('telefone').value = formatTelefoneForDisplay(patientRecord.telefone) || '';

                    handleLogradouroChange({ target: { value: patientRecord.codLogradouro } });
                    handleRacaChange({ target: { value: patientRecord.raca } });
                    validateCNSField({ target: document.getElementById('patientCNS') });

                    document.getElementById('cnsSearchResults').style.display = 'none';
                    document.getElementById('nameSearchResults').style.display = 'none';

                    addLog(`Dados do paciente "${patientRecord.patientId}" pré-preenchidos.`);
                    showToast(`Dados de "${patientRecord.patientId}" pré-preenchidos.`, 'info');
                    updateSubmitButton(false);
                }
            }

            /**
             * Gera o conteúdo CSV completo para exportação.
             * @param {Array<object>} data - Os registros a serem exportados.
             * @returns {string} O conteúdo CSV.
             */
            function generateCompleteCSV(data) {
                const BOM = '\uFEFF';
                const headers = [
                    'DATA_CADASTRO', 'NOME_PACIENTE', 'CNS_CPF', 'SEXO', 'DATA_NASCIMENTO', 'NACIONALIDADE',
                    'RACA_COR', 'ETNIA', 'LOGRADOURO', 'COD_LOGRADOURO',
                    'ENDERECO', 'NUMERO', 'BAIRRO_CORREGO', 'COMPLEMENTO', 'TELEFONE', 'DATA_ATENDIMENTO',
                    'LOCAL_ATENDIMENTO', 'CIDADE', 'DISTANCIA_KM', 'TOTAL_PROCEDIMENTOS', 'HORARIO',
                    'TIPO_ATENDIMENTO', 'TIPO_ATENDIMENTO_CODIGO', 'TRANSPORTE', 'MOTORISTA', 'HORA_SAIDA',
                    'OBSERVACAO', 'ID_PACIENTE_PRINCIPAL', 'STATUS', 'ARQUIVO_ORIGEM', 'LINHA_ORIGEM', 'ID_REGISTRO'
                ];

                let csv = BOM + headers.join(';') + '\n';
                
                data.forEach(record => {
                    // Função auxiliar para escapar campos CSV
                    const escapeCsvField = (field) => {
                        if (field === null || field === undefined) return '';
                        let stringField = String(field);
                        // Se o campo contiver o delimitador, aspas duplas ou quebra de linha, envolva-o em aspas
                        if (stringField.includes(';') || stringField.includes('"') || stringField.includes('\n') || stringField.includes('\r')) {
                            // Escapa aspas duplas dentro do campo (dobra-as)
                            stringField = stringField.replace(/"/g, '""');
                            return `"${stringField}"`;
                        }
                        return stringField;
                    };

                    const row = [
                        escapeCsvField(record.dtCadastro),
                        escapeCsvField(record.patientId),
                        escapeCsvField(formatCNSForDisplay(record.cnsPaciente)),
                        escapeCsvField(getSexoDescription(record.sexo)),
                        escapeCsvField(formatDate(record.dtNascimento)),
                        escapeCsvField(getNacionalidadeDesc(record.nacionalidade)),
                        escapeCsvField(getRacaDesc(record.raca)),
                        escapeCsvField(record.etnia),
                        escapeCsvField(getLogradouroDesc(record.codLogradouro)),
                        escapeCsvField(record.codLogradouro),
                        escapeCsvField(record.endereco),
                        escapeCsvField(record.numero),
                        escapeCsvField(record.bairro),
                        escapeCsvField(record.complemento),
                        escapeCsvField(formatTelefoneForDisplay(record.telefone)),
                        escapeCsvField(formatDate(record.dtAtendimento)),
                        escapeCsvField(record.local),
                        escapeCsvField(record.cidade),
                        escapeCsvField(record.distanciaKm),
                        escapeCsvField(record.totalProcedimentos),
                        escapeCsvField(record.horario),
                        escapeCsvField(getTipoAtendimentoDesc(record.tipoAtendimento)),
                        escapeCsvField(record.tipoAtendimentoCodigo),
                        escapeCsvField(getTransporteDesc(record.transporte)),
                        escapeCsvField(record.motorista),
                        escapeCsvField(record.horaSaida),
                        escapeCsvField(record.observacao),
                        escapeCsvField(record.parentPatientId),
                        escapeCsvField(record.status),
                        escapeCsvField(record.filename),
                        escapeCsvField(record.lineNumber),
                        escapeCsvField(record.id)
                    ];
                    csv += row.join(';') + '\n';
                });

                return csv;
            }

            /**
             * Exporta todos os dados válidos para um arquivo Excel (CSV).
             */
            function exportExcel() {
                const validData = bpaData.filter(r => r.status === 'valid');
                if (validData.length === 0) {
                    showToast('Nenhum dado válido para exportar.', 'info');
                    addLog('Tentativa de exportação: Nenhum dado válido encontrado.');
                    return;
                }
                const csvContent = generateCompleteCSV(validData);
                const now = new Date();
                const filename = `bpa_dados_exportados_${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}.csv`;
                downloadFile(filename, csvContent);
                addLog(`Exportados ${validData.length} registros válidos para ${filename}.`);
                showToast('Dados exportados com sucesso para CSV!', 'success');
                closeConfigModal();
            }

            /**
             * Exibe uma pré-visualização dos dados que seriam exportados para CSV.
             * Mostra apenas os primeiros 5 registros para evitar sobrecarga na UI.
             */
            function previewExport() {
                if (bpaData.length === 0) {
                    addLog('Nenhum dado para visualizar');
                    showToast('Nenhum dado para visualizar.', 'info');
                    return;
                }

                const validData = bpaData.filter(r => r.status === 'valid');
                const previewDiv = document.getElementById('exportPreview');
                const previewHeader = document.getElementById('previewHeader');
                const previewBody = document.getElementById('previewBody');

                previewHeader.innerHTML = '';
                previewBody.innerHTML = '';

                const headers = [
                    'DATA_CADASTRO', 'NOME_PACIENTE', 'CNS_CPF', 'SEXO', 'DATA_NASCIMENTO', 'NACIONALIDADE',
                    'RACA_COR', 'ETNIA', 'LOGRADOURO', 'COD_LOGRADOURO',
                    'ENDERECO', 'NUMERO', 'BAIRRO_CORREGO', 'COMPLEMENTO', 'TELEFONE', 'DATA_ATENDIMENTO',
                    'LOCAL_ATENDIMENTO', 'CIDADE', 'HORARIO', 'TIPO_ATENDIMENTO', 'TRANSPORTE', 'MOTORISTA',
                    'HORA_SAIDA', 'OBSERVACAO', 'ID_PACIENTE_PRINCIPAL', 'ID_REGISTRO'
                ];
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    th.style.minWidth = '120px';
                    headerRow.appendChild(th);
                });
                previewHeader.appendChild(headerRow);

                const previewData = validData.slice(0, 5);
                previewData.forEach(record => {
                    const row = document.createElement('tr');
                    const values = [
                        record.dtCadastro || '', record.patientId || '', formatCNSForDisplay(record.cnsPaciente) || '', getSexoDescription(record.sexo) || '',
                        formatDate(record.dtNascimento) || '', getNacionalidadeDesc(record.nacionalidade) || '',
                        getRacaDesc(record.raca) || '', record.etnia || '', getLogradouroDesc(record.codLogradouro) || '',
                        record.codLogradouro || '',
                        record.endereco || '', record.numero || 's/n', record.bairro || '',
                        record.complemento || '', formatTelefoneForDisplay(record.telefone) || '', formatDate(record.dtAtendimento) || '',
                        record.local || '',
                        record.cidade || '', record.horario || '',
                        getTipoAtendimentoDesc(record.tipoAtendimento) || '',
                        getTransporteDesc(record.transporte) || '', record.motorista || '', record.horaSaida || '', record.observacao || '',
                        record.parentPatientId || '', record.id || ''
                    ];

                    values.forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = escapeHtml(value); // Escapar para preview
                        td.style.maxWidth = '150px';
                        td.style.overflow = 'hidden';
                        td.style.textOverflow = 'ellipsis';
                        td.style.whiteSpace = 'nowrap';
                        row.appendChild(td);
                    });
                    previewBody.appendChild(row);
                });

                if (validData.length > 5) {
                    const row = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = headers.length;
                    td.textContent = `... e mais ${validData.length - 5} registros`;
                    td.style.textAlign = 'center';
                    td.style.fontStyle = 'italic';
                    td.style.color = '#666';
                    row.appendChild(td);
                    previewBody.appendChild(row);
                }

                previewDiv.classList.remove('hidden');
                previewDiv.scrollIntoView({ behavior: 'smooth' });
                addLog(`Preview gerado para ${validData.length} registros válidos.`);
                showToast(`Preview gerado para ${validData.length} registros válidos.`, 'info');
            }

            /** Fecha a seção de visualização da exportação. */
            function closePreview() {
                document.getElementById('exportPreview').classList.add('hidden');
            }
            
            /** Alterna a visibilidade da seção de estatísticas. */
            function toggleStatistics() {
                const statsCard = document.getElementById('statisticsCard');
                if (statsCard.classList.contains('hidden')) {
                    statsCard.classList.remove('hidden');
                    statsCard.scrollIntoView({ behavior: 'smooth' });
                } else {
                    statsCard.classList.add('hidden');
                }
            }

            /**
             * Valida todos os dados existentes no `bpaData`.
             * Esta função itera sobre cada registro, reavalia seus campos
             * e atualiza o status ('valid' ou 'error') e a lista de erros.
             * Ideal para ser chamada após importações ou para uma verificação geral.
             */
            function validateData() {
                addLog('Iniciando validação de todos os dados...');
                let revalidatedCount = 0;
                let errorsFound = 0;

                bpaData.forEach(record => {
                    // Crie uma cópia dos erros originais se precisar compará-los ou mantê-los
                    // const originalErrors = [...record.errors];
                    record.errors = []; // Limpa erros anteriores para revalidação

                    // Revalidar campos críticos
                    if (!isValidCNSOrCPF(record.cnsPaciente)) {
                        record.errors.push('CNS/CPF inválido');
                    }
                    if (!record.patientId || record.patientId.trim() === '') {
                        record.errors.push('Nome do paciente ausente');
                    }
                    // A data de nascimento deve ser uma data válida e a pessoa deve ter pelo menos 0 anos
                    if (!record.dtNascimento || !isValidDate(record.dtNascimento) || isNaN(new Date(formatDateForInput(record.dtNascimento)).getTime())) {
                        record.errors.push('Data de nascimento inválida');
                    }
                    // A data de atendimento deve ser uma data válida
                    if (!record.dtAtendimento || !isValidDate(record.dtAtendimento) || isNaN(new Date(formatDateForInput(record.dtAtendimento)).getTime())) {
                        record.errors.push('Data de atendimento inválida');
                    }
                    // Verifica se a cidade existe nas cidades cadastradas
                    if (!record.cidade || !customCities.some(c => c.name.toLowerCase() === record.cidade.toLowerCase())) {
                        record.errors.push('Cidade inválida ou não cadastrada');
                    }
                    // Verifica se o tipo de atendimento está preenchido
                    if (!record.tipoAtendimento || record.tipoAtendimento.trim() === '') {
                        record.errors.push('Tipo de atendimento ausente');
                    }
                    // Se for acompanhante, deve ter um paciente principal válido
                    if (record.tipoAtendimento === 'acompanhante') {
                        if (!record.parentPatientId || !bpaData.some(p => p.id === record.parentPatientId && p.tipoAtendimento === 'paciente' && p.status === 'valid')) {
                            record.errors.push('Acompanhante sem paciente principal válido vinculado');
                        }
                        // Acompanhante deve ter 18 anos ou mais
                        if (record.dtNascimento && !isAdult(formatDateForInput(record.dtNascimento))) {
                            record.errors.push('Acompanhante menor de 18 anos');
                        }
                    }
                    // Verifica se o transporte está selecionado
                    if (!record.transporte || record.transporte.trim() === '') {
                        record.errors.push('Tipo de transporte ausente');
                    }
                    // Verifica se o logradouro está preenchido
                    if (!record.codLogradouro || record.codLogradouro.trim() === '') {
                        record.errors.push('Logradouro ausente');
                    }
                    // Validações condicionais de endereço/bairro baseadas no logradouro
                    if (record.codLogradouro === '081') { // Área Urbana
                        if (!record.endereco || record.endereco.trim() === '') {
                            record.errors.push('Endereço ausente para área urbana');
                        }
                        if (!record.bairro || record.bairro.trim() === '') {
                            record.errors.push('Bairro ausente para área urbana');
                        }
                    } else if (record.codLogradouro === '024') { // Zona Rural
                        if (!record.bairro || record.bairro.trim() === '') {
                            record.errors.push('Córrego ausente para zona rural');
                        }
                    }
                    // Verifica se o telefone está preenchido (apenas dígitos)
                    if (!record.telefone || record.telefone.replace(/\D/g, '').length < 10) {
                        record.errors.push('Telefone inválido ou incompleto');
                    }
                    
                    // Atualiza o status do registro
                    if (record.errors.length > 0) {
                        record.status = 'error';
                        errorsFound++;
                    } else {
                        record.status = 'valid';
                    }
                    revalidatedCount++;
                });

                saveDataToStorage();
                updateStatistics();
                displayData(); // Atualiza a exibição da tabela com os novos status/erros
                populateAllPatientsForSearch(); // Re-popula a lista de pacientes para busca

                if (errorsFound > 0) {
                    addLog(`Validação concluída: ${revalidatedCount} registros revalidados. ${errorsFound} registros com erros.`);
                    showToast(`Validação concluída: ${errorsFound} registros com erros.`, 'warning');
                } else {
                    addLog(`Validação concluída: ${revalidatedCount} registros revalidados. Nenhum erro encontrado.`);
                    showToast('Todos os registros válidos!', 'success');
                }
            }
            
            // --- Funções de Geração de Relatórios ---

            /**
             * Converte uma string de data YYYY-MM-DD para DDMMAAAA.
             * @param {string} dateString - A data no formato YYYY-MM-DD.
             * @returns {string} A data no formato DDMMAAAA.
             */
            function convertDateToDDMMAAAA(dateString) {
                if (!dateString) return '';
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}${parts[1]}${parts[0]}`;
                }
                return dateString;
            }

            /**
             * Converte uma string de data DDMMAAAA para YYYYMMDD para facilitar comparações.
             * @param {string} dateString - A data no formato DDMMAAAA.
             * @returns {string} A data no formato YYYYMMDD.
             */
            function convertDDMMAAAAtoYYYYMMDD(dateString) {
                if (!dateString || dateString.length !== 8) return '';
                return `${dateString.substring(4, 8)}${dateString.substring(2, 4)}${dateString.substring(0, 2)}`;
            }
            
            /**
             * Gera um relatório de transporte (Ônibus CISVERDE ou Carros da Saúde) com base nos filtros de data.
             * @param {string} transportType - O tipo de transporte ('cisverde' ou 'carros_saude').
             */
            function generateTransportReport(transportType) {
                if (bpaData.length === 0) {
                    showToast('Nenhum dado disponível para gerar relatório.', 'info');
                    return;
                }
                
                currentReportType = transportType;

                const startDateInput = document.getElementById('reportStartDate').value;
                const endDateInput = document.getElementById('reportEndDate').value;

                const filterStartDateYYYYMMDD = startDateInput ? startDateInput.replace(/-/g, '') : '';
                const filterEndDateYYYYMMDD = endDateInput ? endDateInput.replace(/-/g, '') : '';

                let filteredData = bpaData.filter(record => {
                    const recordDateYYYYMMDD = convertDDMMAAAAtoYYYYMMDD(record.dtAtendimento);

                    // Filtra apenas registros válidos e do tipo de transporte selecionado
                    if (record.status !== 'valid' || record.transporte !== transportType) {
                        return false;
                    }
                    // Filtra por período de data de atendimento
                    if (filterStartDateYYYYMMDD && recordDateYYYYMMDD < filterStartDateYYYYMMDD) {
                        return false;
                    }
                    if (filterEndDateYYYYMMDD && recordDateYYYYMMDD > filterEndDateYYYYMMDD) {
                        return false;
                    }
                    return true;
                });
                
                const transportNames = {
                    'cisverde': '🚌 Ônibus CISVERDE',
                    'carros_saude': '🚑 Carros da Saúde',
                };
                
                const reportTitle = `Relatório - ${transportNames[transportType]}`;
                
                generateTransportReportContent(filteredData, reportTitle, startDateInput, endDateInput);
                
                document.getElementById('reportModal').style.display = 'none';
                document.getElementById('reportViewModal').style.display = 'flex';
                showToast('Relatório de transporte gerado.', 'success');
            }
            
            /**
             * Gera um relatório BPA-I completo com base nos filtros de data.
             */
            function generateBPAReport() {
                if (bpaData.length === 0) {
                    showToast('Nenhum dado disponível para gerar relatório.', 'info');
                    return;
                }
                
                currentReportType = 'complete';

                const startDateInput = document.getElementById('reportStartDate').value;
                const endDateInput = document.getElementById('reportEndDate').value;

                const filterStartDateYYYYMMDD = startDateInput ? startDateInput.replace(/-/g, '') : '';
                const filterEndDateYYYYMMDD = endDateInput ? endDateInput.replace(/-/g, '') : '';

                let filteredData = bpaData.filter(record => {
                    const recordDateYYYYMMDD = convertDDMMAAAAtoYYYYMMDD(record.dtAtendimento);

                    // Filtra apenas registros válidos
                    if (record.status !== 'valid') {
                        return false;
                    }
                    // Filtra por período de data de atendimento
                    if (filterStartDateYYYYMMDD && recordDateYYYYMMDD < filterStartDateYYYYMMDD) {
                        return false;
                    }
                    if (filterEndDateYYYYMMDD && recordDateYYYYMMDD > filterEndDateYYYYMMDD) {
                        return false;
                    }
                    return true; // Adicionado: Retorna true se o registro for válido e dentro do período
                });
                
                const reportTitle = '📄 Relatório BPA-I Completo';
                generateReportContent(filteredData, reportTitle, startDateInput, endDateInput);
                
                document.getElementById('reportModal').style.display = 'none';
                document.getElementById('reportViewModal').style.display = 'flex';
                showToast('Relatório BPA-I completo gerado.', 'success');
            }
            
            /**
             * Gera o conteúdo HTML para o relatório BPA-I completo.
             * @param {Array<object>} data - Os registros a serem incluídos no relatório.
             * @param {string} title - O título do relatório.
             * @param {string} startDate - Data inicial do filtro (YYYY-MM-DD).
             * @param {string} endDate - Data final do filtro (YYYY-MM-DD).
             */
            function generateReportContent(data, title, startDate, endDate) {
                const now = new Date().toLocaleString('pt-BR');
                const reportContent = document.getElementById('reportContent');
                const reportTitleElement = document.getElementById('reportTitle');
                
                reportTitleElement.textContent = title;
                
                let dateRangeText = '';
                if (startDate && endDate) {
                    dateRangeText = `Período: ${escapeHtml(formatDate(convertDateToDDMMAAAA(startDate)))} a ${escapeHtml(formatDate(convertDateToDDMMAAAA(endDate)))}`;
                } else if (startDate) {
                    dateRangeText = `A partir de: ${escapeHtml(formatDate(convertDateToDDMMAAAA(startDate)))}`;
                } else if (endDate) {
                    dateRangeText = `Até: ${escapeHtml(formatDate(convertDateToDDMMAAAA(endDate)))}`;
                }

                // Colunas solicitadas pelo usuário
                const headers = [
                    'Nome', 'CNS/CPF', 'Sexo', 'Data Nasc.', 'Nacionalidade',
                    'Raça/Cor', 'Etnia', 'Cod Logradouro', 'Endereço', 'Número',
                    'Bairro/Córrego', 'Telefone', 'Data Atend.', 'Cidade', 'Procedimentos',
                    'Tipo Atend.', 'Tipo Atend. Cód.'
                ];

                let html = `
                    <div class="report-header">
                        <h1>Sistema BPA-I</h1>
                        <h2>${escapeHtml(title)}</h2>
                        <p>Gerado em: ${escapeHtml(now)}</p>
                        <p>Total de registros: ${escapeHtml(data.length)}</p>
                        ${dateRangeText ? `<p>${dateRangeText}</p>` : ''}
                    </div>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                `;
                headers.forEach(header => {
                    html += `<th>${escapeHtml(header)}</th>`;
                });
                html += `
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach(record => {
                    html += `
                        <tr>
                            <td>${escapeHtml(record.patientId || '')}</td>
                            <td>${escapeHtml(formatCNSForDisplay(record.cnsPaciente) || '')}</td>
                            <td>${escapeHtml(record.sexo === '1' ? 'M' : record.sexo === '2' ? 'F' : '')}</td>
                            <td>${escapeHtml(formatDate(record.dtNascimento) || '')}</td>
                            <td>${escapeHtml(getNacionalidadeDesc(record.nacionalidade) || '')}</td>
                            <td>${escapeHtml(getRacaDesc(record.raca) || '')}</td>
                            <td>${escapeHtml(record.etnia || '')}</td>
                            <td>${escapeHtml(record.codLogradouro || '')}</td>
                            <td>${escapeHtml(record.endereco || '')}</td>
                            <td>${escapeHtml(record.numero || 's/n')}</td>
                            <td>${escapeHtml(record.bairro || '')}</td>
                            <td>${escapeHtml(formatTelefoneForDisplay(record.telefone) || '')}</td>
                            <td>${escapeHtml(record.dtAtendimento ? formatDate(record.dtAtendimento) : '')}</td>
                            <td>${escapeHtml(record.cidade || '')}</td>
                            <td>${escapeHtml(record.totalProcedimentos || '0')}</td>
                            <td>${escapeHtml(getTipoAtendimentoDesc(record.tipoAtendimento) || '')}</td>
                            <td>${escapeHtml(record.tipoAtendimentoCodigo || '')}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                reportContent.innerHTML = html;
            }
            
            /**
             * Gera o conteúdo HTML para relatórios de transporte (CISVERDE ou Carros da Saúde).
             * Agrupa pacientes e seus acompanhantes para uma exibição mais organizada.
             * @param {Array<object>} data - Os registros a serem incluídos no relatório.
             * @param {string} title - O título do relatório.
             * @param {string} startDate - Data inicial do filtro (YYYY-MM-DD).
             * @param {string} endDate - Data final do filtro (YYYY-MM-DD).
             */
            function generateTransportReportContent(data, title, startDate, endDate) {
                const now = new Date().toLocaleString('pt-BR');
                const reportContent = document.getElementById('reportContent');
                const reportTitleElement = document.getElementById('reportTitle');
                
                reportTitleElement.textContent = title;
                
                const isCarrosSaudeReport = title.includes('🚑 Carros da Saúde');
                
                // 1. Agrupa pacientes e seus acompanhantes
                const patientGroups = [];
                const patientsMap = new Map();
                const companionsMap = new Map();

                // Separa pacientes e acompanhantes
                data.forEach(record => {
                    if (record.tipoAtendimento === 'paciente') {
                        patientsMap.set(record.id, record);
                    } else if (record.tipoAtendimento === 'acompanhante' && record.parentPatientId) {
                        if (!companionsMap.has(record.parentPatientId)) {
                            companionsMap.set(record.parentPatientId, []);
                        }
                        companionsMap.get(record.parentPatientId).push(record);
                    }
                });

                // Cria grupos de paciente principal + seus acompanhantes
                patientsMap.forEach(patientRecord => {
                    const companionsForThisPatient = companionsMap.get(patientRecord.id) || [];
                    patientGroups.push({ patient: patientRecord, companions: companionsForThisPatient });
                });

                // 2. Ordena os grupos por data e horário de atendimento do paciente principal
                patientGroups.sort((a, b) => {
                    const dateA = convertDDMMAAAAtoYYYYMMDD(a.patient.dtAtendimento);
                    const dateB = convertDDMMAAAAtoYYYYMMDD(b.patient.dtAtendimento);
                    if (dateA !== dateB) {
                        return dateA.localeCompare(dateB);
                    }
                    const timeA = a.patient.horario;
                    const timeB = b.patient.horario;
                    return timeA.localeCompare(timeB);
                });

                let dateRangeText = '';
                if (startDate && endDate) {
                    dateRangeText = `Período: ${escapeHtml(formatDate(convertDateToDDMMAAAA(startDate)))} a ${escapeHtml(formatDate(convertDateToDDMMAAAA(endDate)))}`;
                } else if (startDate) {
                    dateRangeText = `A partir de: ${escapeHtml(formatDate(convertDateToDDMMAAAA(startDate)))}`;
                } else if (endDate) {
                    dateRangeText = `Até: ${escapeHtml(formatDate(convertDateToDDMMAAAA(endDate)))}`;
                }

                let html = `
                    <div class="report-header">
                        <h1>Sistema BPA-I</h1>
                        <h2>${escapeHtml(title)}</h2>
                        <p>Gerado em: ${escapeHtml(now)}</p>
                        <p>Total de registros (filtrados): ${escapeHtml(data.length)}</p>
                        ${dateRangeText ? `<p>${dateRangeText}</p>` : ''}
                    </div>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Data Atend.</th>
                                <th>Horário</th>
                                <th>Nome</th>
                                <th>Local</th>
                                ${isCarrosSaudeReport ? '<th>Cidade</th>' : ''}
                                <th>Acompanhantes Vinculados</th>
                                <th>Observação</th>
                                <th>Telefone</th>
                                <th>Motorista</th>
                                <th>Hora de Saída</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let groupCounter = 0;
                patientGroups.forEach(group => {
                    const groupColorClass = (groupCounter % 2 === 0) ? 'group-even' : 'group-odd';
                    groupCounter++;

                    const patientRecord = group.patient;
                    const linkedCompanionsNames = group.companions.map(c => escapeHtml(c.patientId)).join(', ');

                    html += `
                        <tr class="${groupColorClass}">
                            <td>${escapeHtml(formatDate(patientRecord.dtAtendimento) || '')}</td>
                            <td>${escapeHtml(patientRecord.horario || '')}</td>
                            <td>${escapeHtml(patientRecord.patientId || '')}</td>
                            <td>${escapeHtml(patientRecord.local || '')}</td>
                            ${isCarrosSaudeReport ? `<td>${escapeHtml(patientRecord.cidade || '')}</td>` : ''}
                            <td>${escapeHtml(linkedCompanionsNames || '')}</td>
                            <td>${escapeHtml(patientRecord.observacao || '')}</td>
                            <td>${escapeHtml(formatTelefoneForDisplay(patientRecord.telefone) || '')}</td>
                            <td>${escapeHtml(patientRecord.motorista || '')}</td>
                            <td>${escapeHtml(patientRecord.horaSaida || '')}</td>
                        </tr>
                    `;

                    group.companions.forEach(companionRecord => {
                        html += `
                            <tr class="${groupColorClass} companion-row">
                                <td>${escapeHtml(formatDate(companionRecord.dtAtendimento) || '')}</td>
                                <td>${escapeHtml(companionRecord.horario || '')}</td>
                                <td>${escapeHtml(companionRecord.patientId || '')}</td>
                                <td>${escapeHtml(companionRecord.local || '')}</td>
                                ${isCarrosSaudeReport ? `<td>${escapeHtml(companionRecord.cidade || '')}</td>` : ''}
                                <td></td>
                                <td>${escapeHtml(companionRecord.observacao || '')}</td>
                                <td>${escapeHtml(formatTelefoneForDisplay(companionRecord.telefone) || '')}</td>
                                <td>${escapeHtml(companionRecord.motorista || '')}</td>
                                <td>${escapeHtml(companionRecord.horaSaida || '')}</td>
                            </tr>
                        `;
                    });
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                reportContent.innerHTML = html;
            }
            
            /** Imprime o conteúdo do relatório exibido no modal. */
            function printReport() {
                const reportHtmlContent = document.getElementById('reportContent').innerHTML;
                const reportTitle = document.getElementById('reportTitle').textContent;

                const printWindow = window.open('', '_blank');
                
                const fullHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${escapeHtml(reportTitle)}</title>
                        <style>
                            @page { size: A4 landscape; margin: 0.5cm; }
                            body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: white; }
                            .report-header { text-align: center; margin-bottom: 15px; }
                            .report-header h1 { font-size: 18px; margin: 5px 0; }
                            .report-header h2 { font-size: 16px; margin: 3px 0; }
                            .report-header p { font-size: 12px; margin: 2px 0; }
                            table { width: 100%; border-collapse: collapse; font-size: 8px; }
                            th, td { border: 1px solid black; padding: 2px; text-align: left; word-wrap: break-word; vertical-align: top; }
                            th { background-color: #f5f5f5; font-weight: bold; }
                            .companion-row td {
                                padding-left: 10px !important;
                                font-style: italic;
                                color: #333;
                            }
                            .group-odd {
                                background-color: #f8f8f8 !important;
                            }
                            .group-even {
                                background-color: #f0f0f0 !important;
                            }
                        </style>
                    </head>
                    <body>
                        ${reportHtmlContent}
                    </body>
                    </html>
                `;
                
                printWindow.document.write(fullHtml);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            }
            
            /**
             * Gera um relatório do log de validação e o exibe para impressão.
             */
            function generateValidationLogReport() {
                const logContent = document.getElementById('logArea').value;
                if (!logContent.trim()) {
                    showToast('O log de validação está vazio. Nada para gerar.', 'info');
                    return;
                }

                const now = new Date().toLocaleString('pt-BR');
                const reportTitle = 'Relatório do Log de Validação';

                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${escapeHtml(reportTitle)}</title>
                        <style>
                            @page { size: A4 portrait; margin: 1cm; }
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: white; color: #333; }
                            .report-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
                            .report-header h1 { font-size: 20px; margin-bottom: 5px; color: #2c3e50; }
                            .report-header p { font-size: 12px; color: #7f8c8d; }
                            pre {
                                white-space: pre-wrap; /* Quebra linhas longas */
                                word-wrap: break-word; /* Quebra palavras longas */
                                font-family: 'Consolas', 'Courier New', monospace;
                                font-size: 10px;
                                background-color: #f8f8f8;
                                border: 1px solid #eee;
                                padding: 15px;
                                border-radius: 8px;
                                line-height: 1.4;
                                max-height: 80vh; /* Limita altura para scroll na tela */
                                overflow-y: auto; /* Adiciona scroll se conteúdo for muito longo */
                            }
                        </style>
                    </head>
                    <body>
                        <div class="report-header">
                            <h1>${escapeHtml(reportTitle)}</h1>
                            <p>Gerado em: ${escapeHtml(now)}</p>
                        </div>
                        <pre>${escapeHtml(logContent)}</pre>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();

                addLog('Relatório do Log de Validação gerado.');
                showToast('Relatório do Log de Validação gerado com sucesso!', 'success');
                closeConfigModal();
            }

            // --- Funções de Geração de Dados de Exemplo ---

            /**
             * Gera um número inteiro aleatório dentro de um intervalo.
             * @param {number} min - O valor mínimo (inclusive).
             * @param {number} max - O valor máximo (inclusive).
             * @returns {number} Um número inteiro aleatório.
             */
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            /**
             * Gera um CPF fictício válido.
             * @returns {string} Um CPF fictício.
             */
            function generateFakeCpf() {
                let cpf = Array(9).fill(0).map(() => getRandomInt(0, 9)).join('');
                let sum = 0;
                for (let i = 0; i < 9; i++) sum += parseInt(cpf[i]) * (10 - i);
                let digit1 = 11 - (sum % 11);
                if (digit1 > 9) digit1 = 0;
                cpf += digit1;

                sum = 0;
                for (let i = 0; i < 10; i++) sum += parseInt(cpf[i]) * (11 - i);
                let digit2 = 11 - (sum % 11);
                if (digit2 > 9) digit2 = 0;
                cpf += digit2;
                return cpf;
            }

            /**
             * Gera um CNS fictício.
             * @returns {string} Um CNS fictício.
             */
            function generateFakeCns() {
                let cns = '';
                cns += getRandomInt(7, 9); // Inicia com 7, 8 ou 9
                for (let i = 0; i < 10; i++) {
                    cns += getRandomInt(0, 9);
                }
                for (let i = 0; i < 4; i++) {
                    cns += getRandomInt(0, 9);
                }
                return cns;
            }

            /**
             * Gera uma string de data aleatória (DDMMYYYY) dentro de um intervalo de dias a partir de hoje.
             * @param {number} daysOffset - O número máximo de dias de offset (para frente ou para trás).
             * @returns {string} Uma data aleatória no formato DDMMAAAA.
             */
            function getRandomDate(daysOffset) {
                const date = new Date();
                date.setDate(date.getDate() + getRandomInt(-daysOffset, daysOffset));
                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const yyyy = date.getFullYear();
                return `${dd}${mm}${yyyy}`;
            }

            /** Adiciona um conjunto de registros de exemplo (pacientes e acompanhantes) ao sistema. */
            function addExampleRecords() {
                const today = new Date();
                const currentTime = `${String(getRandomInt(8, 17)).padStart(2, '0')}:${String(getRandomInt(0, 59)).padStart(2, '0')}`;

                const exampleCities = [
                    { name: 'São Paulo', km: 100, procedures: 2 },
                    { name: 'Rio de Janeiro', km: 200, procedures: 4 },
                    { name: 'Belo Horizonte', km: 300, procedures: 6 },
                    { name: 'Campinas', km: 80, procedures: 1 },
                    { name: 'Curitiba', km: 400, procedures: 8 },
                    { name: 'Porto Alegre', km: 500, procedures: 10 },
                    { name: 'Salvador', km: 700, procedures: 14 },
                    { name: 'Fortaleza', km: 900, procedures: 18 }
                ];

                // Adiciona cidades de exemplo se ainda não existirem
                exampleCities.forEach(city => {
                    const cityExists = customCities.some(c => c.name.toLowerCase() === city.name.toLowerCase());
                    if (!cityExists) {
                        customCities.push(city);
                    }
                });
                saveCitiesToStorage();
                updateCitySelect();
                displayCities();

                const firstNames = ['ANA', 'BRUNO', 'CARLA', 'DANIEL', 'ELIANA', 'FABIO', 'GABRIELA', 'HUGO', 'INGRID', 'JULIO', 'LARISSA', 'MARCOS', 'NATALIA', 'OTAVIO', 'PATRICIA', 'QUINTINO', 'RAQUEL', 'SERGIO', 'TATIANA', 'UBIRATAN', 'VANESSA', 'WALDIR', 'XENIA', 'YURI', 'ZELIA'];
                const lastNames = ['SILVA', 'SOUZA', 'OLIVEIRA', 'SANTOS', 'PEREIRA', 'ALMEIDA', 'COSTA', 'RODRIGUES', 'FERREIRA', 'GOMES', 'LIMA', 'CARVALHO', 'MARTINS', 'RAMOS', 'RIBEIRO', 'BARBOSA', 'FREITAS', 'DIAS', 'CASTRO', 'MORAES'];
                const streetTypes = ['RUA', 'AVENIDA', 'TRAVESSA', 'ALAMEDA', 'ESTRADA'];
                const streetNames = ['FLORES', 'PAZ', 'LIBERDADE', 'SOL', 'LUA', 'ESPERANCA', 'ALEGRIA', 'PRIMAVERA', 'VERAO', 'OUTONO', 'INVERNO'];
                const urbanBairros = ['CENTRO', 'JARDIM', 'VILA', 'CIDADE NOVA', 'ALVORADA', 'FLORESTA', 'SANTOS DUMONT', 'CRUZEIRO', 'SANTA CRUZ'];
                const ruralBairros = ['CÓRREGO FUNDO', 'FAZENDA ALEGRE', 'SITIO VERDE', 'POVOADO DA SERRA', 'VALE DO SOL'];
                const locals = ['HOSPITAL GERAL', 'CLÍNICA DA FAMÍLIA', 'POSTO DE SAÚDE', 'CENTRO DE ESPECIALIDADES', 'AMBULATÓRIO'];
                const observacoes = ['Consulta de rotina', 'Exame agendado', 'Retorno médico', 'Sessão de fisioterapia', 'Acompanhamento pós-cirúrgico', 'Vacinação', 'Atendimento de urgência'];

                const newRecords = [];
                const patientIds = []; // Para armazenar IDs de pacientes principais para vincular acompanhantes

                // Gera 15 registros de pacientes
                for (let i = 0; i < 15; i++) {
                    const patientId = generateUniqueId();
                    patientIds.push(patientId);

                    const firstName = firstNames[getRandomInt(0, firstNames.length - 1)];
                    const lastName1 = lastNames[getRandomInt(0, lastNames.length - 1)];
                    const lastName2 = lastNames[getRandomInt(0, lastNames.length - 1)];
                    const patientName = `${firstName} ${lastName1} ${lastName2}`;

                    const cnsCpf = i % 2 === 0 ? generateFakeCns() : generateFakeCpf();
                    
                    const birthDay = String(getRandomInt(1, 28)).padStart(2, '0');
                    const birthMonth = String(getRandomInt(1, 12)).padStart(2, '0');
                    const birthYear = String(getRandomInt(1940, 2005));
                    const birthDate = `${birthDay}${birthMonth}${birthYear}`;

                    const gender = getRandomInt(1, 2).toString();
                    const raca = ['01', '02', '03', '04', '05', '99'][getRandomInt(0, 5)];
                    const etnia = raca === '05' ? `000${getRandomInt(1, 9)}` : '';

                    const codLogradouro = getRandomInt(0, 1) === 0 ? '081' : '024';
                    const endereco = codLogradouro === '081' ? `${streetTypes[getRandomInt(0, streetTypes.length - 1)]} ${streetNames[getRandomInt(0, streetNames.length - 1)]}` : '';
                    const numero = codLogradouro === '081' ? (getRandomInt(0, 1) === 0 ? 's/n' : String(getRandomInt(1, 999))) : 's/n';
                    const complemento = getRandomInt(0, 3) === 0 ? `APTO ${getRandomInt(1, 200)}` : '';
                    const bairro = codLogradouro === '081' ? urbanBairros[getRandomInt(0, urbanBairros.length - 1)] : ruralBairros[getRandomInt(0, ruralBairros.length - 1)];
                    
                    const ddd = String(getRandomInt(11, 99));
                    const telPrefix = String(getRandomInt(90000, 99999));
                    const telSuffix = String(getRandomInt(0, 9999)).padStart(4, '0');
                    const telefone = `${ddd}${telPrefix}${telSuffix}`;

                    const cityData = exampleCities[getRandomInt(0, exampleCities.length - 1)];
                    const local = locals[getRandomInt(0, locals.length - 1)];
                    const transporte = getRandomInt(0, 1) === 0 ? 'cisverde' : 'carros_saude';

                    newRecords.push({
                        id: patientId,
                        filename: 'exemplo_gerado',
                        lineNumber: bpaData.length + newRecords.length + 1,
                        originalLine: 'EXEMPLO',
                        patientId: patientName.toUpperCase(),
                        cnsPaciente: cnsCpf,
                        dtNascimento: birthDate,
                        sexo: gender,
                        nacionalidade: '010',
                        raca: raca,
                        etnia: etnia,
                        codLogradouro: codLogradouro,
                        endereco: endereco.toUpperCase(),
                        numero: numero,
                        complemento: complemento.toUpperCase(),
                        bairro: bairro.toUpperCase(),
                        telefone: telefone,
                        dtCadastro: new Date().toLocaleString('pt-BR'),
                        cnes: `000000${getRandomInt(0, 9)}`,
                        cbo: `00000${getRandomInt(0, 9)}`,
                        dtAtendimento: getRandomDate(10),
                        local: local.toUpperCase(),
                        cidade: cityData.name,
                        distanciaKm: cityData.km,
                        totalProcedimentos: cityData.procedures,
                        horario: currentTime,
                        tipoAtendimento: 'paciente',
                        tipoAtendimentoCodigo: '08.03.01.012-5',
                        transporte: transporte,
                        motorista: '',
                        horaSaida: '',
                        observacao: observacoes[getRandomInt(0, observacoes.length - 1)],
                        caraAtendimento: '01',
                        origem: '1',
                        status: 'valid',
                        errors: [],
                        parentPatientId: ''
                    });
                }

                // Gera 15 registros de acompanhantes vinculados aos pacientes gerados
                for (let i = 0; i < 15; i++) {
                    const parentPatientId = patientIds[i % patientIds.length];
                    const parentPatientRecord = newRecords.find(rec => rec.id === parentPatientId);
                    const parentPatientTransport = parentPatientRecord ? parentPatientRecord.transporte : (getRandomInt(0, 1) === 0 ? 'carros_saude' : 'cisverde');

                    const firstName = firstNames[getRandomInt(0, firstNames.length - 1)];
                    const lastName1 = lastNames[getRandomInt(0, lastNames.length - 1)];
                    const companionName = `${firstName} ${lastName1}`;

                    const cnsCpf = i % 2 === 0 ? generateFakeCns() : generateFakeCpf();
                    
                    const birthDay = String(getRandomInt(1, 28)).padStart(2, '0');
                    const birthMonth = String(getRandomInt(1, 12)).padStart(2, '0');
                    const birthYear = String(getRandomInt(1960, 1995)); // Acompanhantes são geralmente mais velhos
                    const birthDate = `${birthDay}${birthMonth}${birthYear}`;

                    const gender = getRandomInt(1, 2).toString();
                    const raca = ['01', '02', '03', '04', '05', '99'][getRandomInt(0, 5)];
                    const etnia = raca === '05' ? `000${getRandomInt(1, 9)}` : '';

                    const codLogradouro = getRandomInt(0, 1) === 0 ? '081' : '024';
                    const endereco = codLogradouro === '081' ? `${streetTypes[getRandomInt(0, streetTypes.length - 1)]} ${streetNames[getRandomInt(0, streetNames.length - 1)]}` : '';
                    const numero = codLogradouro === '081' ? (getRandomInt(0, 1) === 0 ? 's/n' : String(getRandomInt(1, 999))) : 's/n';
                    const complemento = getRandomInt(0, 3) === 0 ? `BLOCO ${String.fromCharCode(65 + i)}` : '';
                    const bairro = codLogradouro === '081' ? urbanBairros[getRandomInt(0, urbanBairros.length - 1)] : ruralBairros[getRandomInt(0, ruralBairros.length - 1)];
                    
                    const ddd = String(getRandomInt(11, 99));
                    const telPrefix = String(getRandomInt(90000, 99999));
                    const telSuffix = String(getRandomInt(0, 9999)).padStart(4, '0');
                    const telefone = `${ddd}${telPrefix}${telSuffix}`;

                    const cityData = exampleCities[getRandomInt(0, exampleCities.length - 1)];
                    const local = locals[getRandomInt(0, locals.length - 1)];
                    const transporte = parentPatientTransport; // Acompanhante usa o mesmo transporte do paciente principal

                    const observationText = parentPatientRecord ? `Acompanhante de ${parentPatientRecord.patientId}` : 'Acompanhante';

                    newRecords.push({
                        id: generateUniqueId(),
                        filename: 'exemplo_gerado',
                        lineNumber: bpaData.length + newRecords.length + 1,
                        originalLine: 'EXEMPLO',
                        patientId: companionName.toUpperCase(),
                        cnsPaciente: cnsCpf,
                        dtNascimento: birthDate,
                        sexo: gender,
                        nacionalidade: '010',
                        raca: raca,
                        etnia: etnia,
                        codLogradouro: codLogradouro,
                        endereco: endereco.toUpperCase(),
                        numero: numero,
                        complemento: complemento.toUpperCase(),
                        bairro: bairro.toUpperCase(),
                        telefone: telefone,
                        dtCadastro: new Date().toLocaleString('pt-BR'),
                        cnes: `000000${getRandomInt(0, 9)}`,
                        cbo: `00000${getRandomInt(0, 9)}`,
                        dtAtendimento: getRandomDate(10),
                        local: local.toUpperCase(),
                        cidade: cityData.name,
                        distanciaKm: cityData.km,
                        totalProcedimentos: cityData.procedures,
                        horario: currentTime,
                        tipoAtendimento: 'acompanhante',
                        tipoAtendimentoCodigo: '08.03.01.010-9',
                        transporte: transporte,
                        motorista: '',
                        horaSaida: '',
                        observacao: observationText,
                        caraAtendimento: '01',
                        origem: '1',
                        status: 'valid',
                        errors: [],
                        parentPatientId: parentPatientId
                    });
                }

                bpaData.push(...newRecords);
                saveDataToStorage();
                updateStatistics();
                displayData();
                populateAllPatientsForSearch();
                addLog(`Adicionados ${newRecords.length} registros de exemplo.`);
                showToast(`Foram adicionados ${newRecords.length} registros de exemplo ao sistema!`, 'success');
            }

            // --- Funções de Notificação (Toast) ---

            /**
             * Exibe uma mensagem toast na parte inferior direita da tela.
             * @param {string} message - A mensagem a ser exibida.
             * @param {'info'|'success'|'error'|'warning'} type - O tipo de mensagem (afeta a cor e o ícone).
             * @param {number} duration - Duração da mensagem em milissegundos.
             */
            function showToast(message, type = 'info', duration = 3000) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    console.error('Toast container not found!');
                    return;
                }

                const toast = document.createElement('div');
                toast.classList.add('toast', type);

                let icon = '';
                switch (type) {
                    case 'success': icon = '✅'; break;
                    case 'error': icon = '❌'; break;
                    case 'warning': icon = '⚠️'; break;
                    case 'info': icon = 'ℹ️'; break;
                    default: icon = '';
                }

                toast.innerHTML = `<span class="toast-icon">${icon}</span> ${escapeHtml(message)}`;
                
                toastContainer.appendChild(toast);

                // Força o reflow para a transição funcionar
                void toast.offsetWidth; 
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }

            // --- Inicialização da Aplicação ---

            // Garante que todos os modais estejam ocultos assim que o script é carregado
            // Isso ajuda a prevenir um "flash" dos modais antes do DOMContentLoaded
            closeAllModals();

            /**
             * Função de inicialização que é executada quando o DOM é completamente carregado.
             * Carrega dados, inicializa a UI e configura listeners de eventos.
             */
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOMContentLoaded disparado, garantindo que todos os modais estão fechados...');
                // Garante que todos os modais estejam fechados na inicialização
                closeAllModals(); // Chamada adicional para garantir

                loadCitiesFromStorage();

                // Adiciona a cidade de origem padrão se ainda não existir
                const pedraBonitaExists = customCities.some(city => 
                    city.name.toLowerCase() === ORIGIN_CITY_NAME.toLowerCase() && 
                    city.state?.toLowerCase() === ORIGIN_CITY_STATE.toLowerCase()
                );
                if (!pedraBonitaExists) {
                    customCities.push({ name: ORIGIN_CITY_NAME, km: 0, procedures: 0, state: ORIGIN_CITY_STATE });
                    saveCitiesToStorage();
                    updateCitySelect();
                }

                loadDataFromStorage();
                addLog('Sistema BPA-I iniciado - Pronto para processar dados');
                showToast('Sistema BPA-I iniciado!', 'info');

                // Configura listeners de eventos para os campos do formulário
                document.getElementById('patientCNS').addEventListener('input', handleCNSInput);
                document.getElementById('patientCNS').addEventListener('blur', validateCNSField);
                document.getElementById('patientCNS').addEventListener('input', (event) => filterPatientSuggestions(event.target.value, 'cns'));
                document.getElementById('patientCNS').addEventListener('blur', () => setTimeout(() => document.getElementById('cnsSearchResults').style.display = 'none', 200));

                document.getElementById('patientName').addEventListener('input', handleNameInput);
                document.getElementById('patientName').addEventListener('input', (event) => filterPatientSuggestions(event.target.value, 'name'));
                document.getElementById('patientName').addEventListener('blur', () => setTimeout(() => document.getElementById('nameSearchResults').style.display = 'none', 200));

                document.getElementById('telefone').addEventListener('input', handleTelefoneInput);
                document.getElementById('codLogradouro').addEventListener('change', handleLogradouroChange);
                document.getElementById('raca').addEventListener('change', handleRacaChange);
                document.getElementById('tipoAtendimento').addEventListener('change', handleTipoAtendimentoChange);
                document.getElementById('birthDate').addEventListener('change', updateTipoAtendimentoOptions);

                document.getElementById('parentPatientSearch').addEventListener('input', filterParentPatients);
                document.getElementById('parentPatientSearch').addEventListener('blur', () => {
                    setTimeout(() => {
                        document.getElementById('parentPatientSearchResults').style.display = 'none';
                    }, 200);
                });

                // Adiciona listeners para os botões de transporte
                document.querySelectorAll('.transport-btn').forEach(button => {
                    button.addEventListener('click', () => selectTransport(button));
                });

                // Listener para o botão de submit do formulário principal
                document.getElementById('submitBtn').onclick = addManualRecord;

                // Garante que o estado inicial do campo de Paciente Principal esteja correto
                const tipoAtendimentoInput = document.getElementById('tipoAtendimento');
                const parentPatientGroup = document.getElementById('parentPatientGroup');

                function updateParentPatientVisibility() {
                    if (tipoAtendimentoInput.value === 'acompanhante') {
                        parentPatientGroup.style.display = 'block';
                        populateAllPatientsForSearch();
                    } else {
                        parentPatientGroup.style.display = 'none';
                        document.getElementById('parentPatientSearch').value = '';
                        document.getElementById('parentPatientId').value = '';
                        document.getElementById('parentPatientSearchResults').innerHTML = '';
                    }
                }
                updateParentPatientVisibility(); // Chama na inicialização para definir o estado correto

                // NOVO: Listener para cálculo automático de procedimentos ao digitar a distância
                document.getElementById('cityKm').addEventListener('input', function() {
                    const cityKmInput = this;
                    const cityProceduresInput = document.getElementById('cityProcedures');
                    const distanceKm = parseInt(cityKmInput.value);

                    if (!isNaN(distanceKm) && distanceKm >= 0) {
                        const procedures = Math.floor(distanceKm / 50);
                        cityProceduresInput.value = procedures;
                    } else if (cityKmInput.value.trim() === '') {
                        cityProceduresInput.value = ''; // Limpa procedimentos se KM estiver vazio
                    } else {
                        cityProceduresInput.value = 'Inválido'; // Indica input inválido
                    }
                });
            });
        </script>
    </body>
    </html>
